From 8388fd3605a31f15deb6ab5f64d5d0e311e9ce2d Mon Sep 17 00:00:00 2001
From: Florian Schilhabel <florian.c.schilhabel@googlemail.com>
Date: Thu, 15 Jul 2010 19:04:36 +0200
Subject: [PATCH 36/40] staging: rtl8192su: merge changes into ieee80211_rx_ADDBARsp()

Signed-off-by: Florian Schilhabel <florian.c.schilhabel@googlemail.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>
---
 .../staging/rtl8192su/ieee80211/rtl819x_BAProc.c   |   14 ++++----------
 1 files changed, 4 insertions(+), 10 deletions(-)

--- a/drivers/staging/rtl8192su/ieee80211/rtl819x_BAProc.c
+++ b/drivers/staging/rtl8192su/ieee80211/rtl819x_BAProc.c
@@ -265,9 +265,6 @@ void ieee80211_send_ADDBAReq(struct ieee
 	if (skb)
 	{
 		softmac_mgmt_xmit(skb, ieee);
-		//add statistic needed here.
-		//and skb will be freed in softmac_mgmt_xmit(), so omit all dev_kfree_skb_any() outside softmac_mgmt_xmit()
-		//WB
 	}
 	else
 	{
@@ -291,7 +288,6 @@ void ieee80211_send_ADDBARsp(struct ieee
 	if (skb)
 	{
 		softmac_mgmt_xmit(skb, ieee);
-		//same above
 	}
 	else
 	{
@@ -318,7 +314,6 @@ void ieee80211_send_DELBA(struct ieee802
 	if (skb)
 	{
 		softmac_mgmt_xmit(skb, ieee);
-		//same above
 	}
 	else
 	{
@@ -414,7 +409,6 @@ int ieee80211_rx_ADDBAReq( struct ieee80
 	ActivateBAEntry(ieee, pBA, 0);
 	ieee80211_send_ADDBARsp(ieee, dst, pBA, ADDBA_STATUS_SUCCESS);
 
-	// End of procedure.
 	return 0;
 
 OnADDBAReq_Fail:
@@ -546,11 +540,11 @@ int ieee80211_rx_ADDBARsp( struct ieee80
 		pAdmittedBA->BaParamSet = *pBaParamSet;
 		DeActivateBAEntry(ieee, pAdmittedBA);
 		ActivateBAEntry(ieee, pAdmittedBA, *pBaTimeoutVal);
-	}
-	else
-	{
-		// Delay next ADDBA process.
+	} else {
 		pTS->bAddBaReqDelayed = true;
+		pTS->bDisable_AddBa = true;
+		ReasonCode = DELBA_REASON_END_BA;
+		goto OnADDBARsp_Reject;
 	}
 
 	// End of procedure
