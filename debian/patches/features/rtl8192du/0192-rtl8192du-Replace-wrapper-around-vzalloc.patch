From 9ee1a9b4e1ef4004e2aa2296251669ed56ca5a86 Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Mon, 17 Feb 2014 11:45:44 -0600
Subject: [PATCH 192/390] rtl8192du: Replace wrapper around vzalloc

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 core/rtw_mlme.c         |  4 ++--
 core/rtw_recv.c         |  5 +----
 core/rtw_sta_mgt.c      |  3 ++-
 core/rtw_xmit.c         | 12 ++++++------
 hal/rtl8192d_hal_init.c |  3 ++-
 include/osdep_service.h |  2 --
 os_dep/os_intfs.c       |  5 +++--
 os_dep/osdep_service.c  | 11 +----------
 os_dep/usb_intf.c       |  4 ++--
 9 files changed, 19 insertions(+), 30 deletions(-)

--- a/drivers/staging/rtl8192du/core/rtw_mlme.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme.c
@@ -54,7 +54,7 @@ int _rtw_init_mlme_priv(struct rtw_adapt
 	_func_enter_;
 
 	/*  We don't need to memset padapter->XXX to zero,
-	 * because adapter is allocated by rtw_zvmalloc(). */
+	 * because adapter is allocated by vzalloc(). */
 
 	pmlmepriv->nic_hdl = (u8 *)padapter;
 
@@ -71,7 +71,7 @@ int _rtw_init_mlme_priv(struct rtw_adapt
 
 	memset(&pmlmepriv->assoc_ssid, 0, sizeof(struct ndis_802_11_ssid));
 
-	pbuf = rtw_zvmalloc(MAX_BSS_CNT * (sizeof(struct wlan_network)));
+	pbuf = vzalloc(MAX_BSS_CNT * (sizeof(struct wlan_network)));
 
 	if (pbuf == NULL) {
 		res = _FAIL;
--- a/drivers/staging/rtl8192du/core/rtw_recv.c
+++ b/drivers/staging/rtl8192du/core/rtw_recv.c
@@ -62,9 +62,6 @@ int _rtw_init_recv_priv(struct recv_priv
 
 	_func_enter_;
 
-	/*  We don't need to memset padapter->XXX to zero, because adapter is allocated by rtw_zvmalloc(). */
-	/* memset((unsigned char *)precvpriv, 0, sizeof (struct  recv_priv)); */
-
 	_rtw_spinlock_init(&precvpriv->lock);
 
 	_rtw_init_queue(&precvpriv->free_recv_queue);
@@ -78,7 +75,7 @@ int _rtw_init_recv_priv(struct recv_priv
 	rtw_os_recv_resource_init(precvpriv, padapter);
 
 	precvpriv->pallocated_frame_buf =
-	    rtw_zvmalloc(NR_RECVFRAME * sizeof(union recv_frame) +
+	    vzalloc(NR_RECVFRAME * sizeof(union recv_frame) +
 			 RXFRAME_ALIGN_SZ);
 
 	if (precvpriv->pallocated_frame_buf == NULL) {
--- a/drivers/staging/rtl8192du/core/rtw_sta_mgt.c
+++ b/drivers/staging/rtl8192du/core/rtw_sta_mgt.c
@@ -82,7 +82,8 @@ u32	_rtw_init_sta_priv(struct	sta_priv *
 
 _func_enter_;
 
-	pstapriv->pallocated_stainfo_buf = rtw_zvmalloc(sizeof(struct sta_info) * NUM_STA + 4);
+	pstapriv->pallocated_stainfo_buf = vzalloc(sizeof(struct sta_info) *
+						   NUM_STA + 4);
 
 	if (!pstapriv->pallocated_stainfo_buf)
 		return _FAIL;
--- a/drivers/staging/rtl8192du/core/rtw_xmit.c
+++ b/drivers/staging/rtl8192du/core/rtw_xmit.c
@@ -26,9 +26,8 @@
 #include <osdep_intf.h>
 #include <linux/ip.h>
 #include <usb_osintf.h>
-
 #include <usb_ops.h>
-
+#include <linux/vmalloc.h>
 
 static u8 P802_1H_OUI[P80211_OUI_LEN] = { 0x00, 0x00, 0xf8 };
 static u8 RFC1042_OUI[P80211_OUI_LEN] = { 0x00, 0x00, 0x00 };
@@ -72,7 +71,7 @@ s32	_rtw_init_xmit_priv(struct xmit_priv
 
 _func_enter_;
 
-	/*  We don't need to memset padapter->XXX to zero, because adapter is allocated by rtw_zvmalloc(). */
+	/*  We don't need to memset padapter->XXX to zero, because adapter is allocated by vzalloc(). */
 	/* memset((unsigned char *)pxmitpriv, 0, sizeof(struct xmit_priv)); */
 
 	_rtw_spinlock_init(&pxmitpriv->lock);
@@ -99,7 +98,7 @@ _func_enter_;
 	Please also apply  free_txobj to link_up all the xmit_frames...
 	*/
 
-	pxmitpriv->pallocated_frame_buf = rtw_zvmalloc(NR_XMITFRAME * sizeof(struct xmit_frame) + 4);
+	pxmitpriv->pallocated_frame_buf = vzalloc(NR_XMITFRAME * sizeof(struct xmit_frame) + 4);
 
 	if (pxmitpriv->pallocated_frame_buf  == NULL) {
 		pxmitpriv->pxmit_frame_buf = NULL;
@@ -136,7 +135,7 @@ _func_enter_;
 	_rtw_init_queue(&pxmitpriv->free_xmitbuf_queue);
 	_rtw_init_queue(&pxmitpriv->pending_xmitbuf_queue);
 
-	pxmitpriv->pallocated_xmitbuf = rtw_zvmalloc(NR_XMITBUFF * sizeof(struct xmit_buf) + 4);
+	pxmitpriv->pallocated_xmitbuf = vzalloc(NR_XMITBUFF * sizeof(struct xmit_buf) + 4);
 
 	if (pxmitpriv->pallocated_xmitbuf  == NULL) {
 		RT_TRACE(_module_rtl871x_xmit_c_, _drv_err_, ("alloc xmit_buf fail!\n"));
@@ -173,7 +172,8 @@ _func_enter_;
 	/*  Init xmit extension buff */
 	_rtw_init_queue(&pxmitpriv->free_xmit_extbuf_queue);
 
-	pxmitpriv->pallocated_xmit_extbuf = rtw_zvmalloc(NR_XMIT_EXTBUFF * sizeof(struct xmit_buf) + 4);
+	pxmitpriv->pallocated_xmit_extbuf = vzalloc(NR_XMIT_EXTBUFF *
+						    sizeof(struct xmit_buf)+4);
 
 	if (pxmitpriv->pallocated_xmit_extbuf  == NULL) {
 		RT_TRACE(_module_rtl871x_xmit_c_, _drv_err_, ("alloc xmit_extbuf fail!\n"));
--- a/drivers/staging/rtl8192du/hal/rtl8192d_hal_init.c
+++ b/drivers/staging/rtl8192du/hal/rtl8192d_hal_init.c
@@ -26,6 +26,7 @@
 #include <hal_intf.h>
 #include <usb_hal.h>
 #include <rtl8192d_hal.h>
+#include <linux/vmalloc.h>
 
 atomic_t GlobalMutexForGlobaladapterList = ATOMIC_INIT(0);
 atomic_t GlobalMutexForMac0_2G_Mac1_5G = ATOMIC_INIT(0);
@@ -307,7 +308,7 @@ int FirmwareDownload92D(struct rtw_adapt
 	if (adapter->bSurpriseRemoved)
 		return _FAIL;
 
-	pFirmware = (struct RT_FIRMWARE_92D *)rtw_zvmalloc(sizeof(struct RT_FIRMWARE_92D));
+	pFirmware = (struct RT_FIRMWARE_92D *)vzalloc(sizeof(struct RT_FIRMWARE_92D));
 	if (!pFirmware) {
 		rtStatus = _FAIL;
 		goto Exit;
--- a/drivers/staging/rtl8192du/include/osdep_service.h
+++ b/drivers/staging/rtl8192du/include/osdep_service.h
@@ -293,12 +293,10 @@ enum {
 
 #define rtw_update_mem_stat(flag, sz) do {} while (0)
 extern u8*	_rtw_vmalloc(u32 sz);
-extern u8*	_rtw_zvmalloc(u32 sz);
 extern u8*	_rtw_zmalloc(u32 sz);
 extern u8*	_rtw_malloc(u32 sz);
 
 #define rtw_vmalloc(sz)			_rtw_vmalloc((sz))
-#define rtw_zvmalloc(sz)			_rtw_zvmalloc((sz))
 #define rtw_malloc(sz)			_rtw_malloc((sz))
 #define rtw_zmalloc(sz)			_rtw_zmalloc((sz))
 
--- a/drivers/staging/rtl8192du/os_dep/os_intfs.c
+++ b/drivers/staging/rtl8192du/os_dep/os_intfs.c
@@ -1279,8 +1279,9 @@ _func_enter_;
 		goto exit;
 	}
 
-	/*  We don't need to memset padapter->XXX to zero, because adapter is allocated by rtw_zvmalloc(). */
-
+	/* We don't need to memset padapter->XXX to zero, because adapter
+	 * is allocated by vzalloc().
+	 */
 	if (_rtw_init_sta_priv(&padapter->stapriv) == _FAIL)
 	{
 		DBG_8192D("Can't _rtw_init_sta_priv\n");
--- a/drivers/staging/rtl8192du/os_dep/osdep_service.c
+++ b/drivers/staging/rtl8192du/os_dep/osdep_service.c
@@ -70,15 +70,6 @@ inline u8* _rtw_vmalloc(u32 sz)
 	return pbuf;
 }
 
-inline u8* _rtw_zvmalloc(u32 sz)
-{
-	u8	*pbuf;
-	pbuf = _rtw_vmalloc(sz);
-	if (pbuf != NULL)
-		memset(pbuf, 0, sz);
-	return pbuf;
-}
-
 u8* _rtw_malloc(u32 sz)
 {
 
@@ -649,7 +640,7 @@ struct net_device *rtw_alloc_etherdev(in
 
 	pnpi = netdev_priv(pnetdev);
 
-	pnpi->priv = rtw_zvmalloc(sizeof_priv);
+	pnpi->priv = vzalloc(sizeof_priv);
 	if (!pnpi->priv) {
 		free_netdev(pnetdev);
 		pnetdev = NULL;
--- a/drivers/staging/rtl8192du/os_dep/usb_intf.c
+++ b/drivers/staging/rtl8192du/os_dep/usb_intf.c
@@ -973,9 +973,9 @@ static struct rtw_adapter *rtw_usb_if1_i
 	struct net_device *pnetdev = NULL;
 	int status = _FAIL;
 
-	if ((padapter = (struct rtw_adapter *)rtw_zvmalloc(sizeof(*padapter))) == NULL) {
+	padapter = (struct rtw_adapter *)vzalloc(sizeof(*padapter));
+	if (!padapter)
 		goto exit;
-	}
 	padapter->dvobj = dvobj;
 	dvobj->if1 = padapter;
 
