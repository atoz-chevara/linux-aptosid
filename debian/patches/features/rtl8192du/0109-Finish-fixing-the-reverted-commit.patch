From 3b33aa1135cb65747f6a2d545aea1f969acf3c86 Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Fri, 3 May 2013 13:29:13 -0500
Subject: [PATCH 109/210] Finish fixing the reverted commit

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 core/rtw_wlan_util.c   | 2 +-
 include/rtw_mlme_ext.h | 2 +-
 include/wlan_bssdef.h  | 8 ++++----
 os_dep/ioctl_linux.c   | 4 ++--
 4 files changed, 8 insertions(+), 8 deletions(-)

--- a/drivers/staging/rtl8192du/core/rtw_wlan_util.c
+++ b/drivers/staging/rtl8192du/core/rtw_wlan_util.c
@@ -1573,7 +1573,7 @@ void set_sta_rate(struct rtw_adapter *pa
 // Update RRSR and Rate for USERATE
 void update_tx_basic_rate(struct rtw_adapter *padapter, u8 wirelessmode)
 {
-	NDIS_802_11_RATES_EX	supported_rates;
+	unsigned char supported_rates[NDIS_802_11_LENGTH_RATES_EX];
 	struct mlme_ext_priv	*pmlmeext = &padapter->mlmeextpriv;
 #ifdef CONFIG_P2P
 	struct wifidirect_info*	pwdinfo = &padapter->wdinfo;
--- a/drivers/staging/rtl8192du/include/rtw_mlme_ext.h
+++ b/drivers/staging/rtl8192du/include/rtw_mlme_ext.h
@@ -316,7 +316,7 @@ struct FW_Sta_Info
 	u32	status;
 	u32	rx_pkt;
 	u32	retry;
-	NDIS_802_11_RATES_EX  SupportedRates;
+	unsigned char  SupportedRates[NDIS_802_11_LENGTH_RATES_EX];
 };
 
 /*
--- a/drivers/staging/rtl8192du/include/wlan_bssdef.h
+++ b/drivers/staging/rtl8192du/include/wlan_bssdef.h
@@ -27,7 +27,7 @@
 #define NDIS_802_11_LENGTH_RATES        8
 #define NDIS_802_11_LENGTH_RATES_EX     16
 
-typedef unsigned char   NDIS_802_11_RATES_EX[NDIS_802_11_LENGTH_RATES_EX];  // Set of 16 data rates
+//typedef unsigned char   NDIS_802_11_RATES_EX[NDIS_802_11_LENGTH_RATES_EX];  // Set of 16 data rates
 
 struct ndis_802_11_ssid {
 	u32  SsidLength;
@@ -83,9 +83,9 @@ struct ndis_802_11_variable_ies {
 
 /*
 Length is the 4 bytes multiples of the sume of
-	sizeof (6 * sizeof(unsigned char)) + 2 + sizeof (struct ndis_802_11_ssid) + sizeof (u32)
+	6 * sizeof(unsigned char) + 2 + sizeof (struct ndis_802_11_ssid) + sizeof (u32)
 +   sizeof (long) + sizeof (NDIS_802_11_NETWORK_TYPE) + sizeof (struct ndis_802_11_config)
-+   sizeof (NDIS_802_11_RATES_EX) + IELength
++   NDIS_802_11_LENGTH_RATES_EX * sizeof(unsigned char) + IELength
 
 Except the IELength, all other fields are fixed length. Therefore, we can define a marco to present the
 partial sum.
@@ -233,7 +233,7 @@ struct wlan_bssid_ex {
 	enum NDIS_802_11_NETWORK_TYPE  NetworkTypeInUse;
 	struct ndis_802_11_config  Configuration;
 	enum NDIS_802_11_NETWORK_INFRASTRUCTURE  InfrastructureMode;
-	NDIS_802_11_RATES_EX  SupportedRates;
+	unsigned char SupportedRates[NDIS_802_11_LENGTH_RATES_EX];
 	struct wlan_phy_info PhyInfo;
 	u32  IELength;
 	u8  IEs[MAX_IE_SZ];	//(timestamp, beacon interval, and capability information)
--- a/drivers/staging/rtl8192du/os_dep/ioctl_linux.c
+++ b/drivers/staging/rtl8192du/os_dep/ioctl_linux.c
@@ -1050,7 +1050,7 @@ static int rtw_wx_get_name(struct net_de
 	u8 ht_cap=false;
 	struct	mlme_priv	*pmlmepriv = &(padapter->mlmepriv);
 	struct wlan_bssid_ex *pcur_bss = &pmlmepriv->cur_network.network;
-	NDIS_802_11_RATES_EX* prates = NULL;
+	unsigned char prates[NDIS_802_11_LENGTH_RATES_EX] = {0};
 
 	RT_TRACE(_module_rtl871x_mlme_c_,_drv_info_,("cmd_code=%x\n", info->cmd));
 
@@ -1065,7 +1065,7 @@ static int rtw_wx_get_name(struct net_de
 			ht_cap = true;
 		}
 
-		prates = &pcur_bss->SupportedRates;
+		memcpy(prates, pcur_bss->SupportedRates, NDIS_802_11_LENGTH_RATES_EX);
 
 		if (rtw_is_cckratesonly_included((u8*)prates) == true)
 		{
