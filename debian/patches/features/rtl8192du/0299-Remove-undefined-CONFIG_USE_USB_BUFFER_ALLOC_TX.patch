From 87e7c6b9e159824f1f259cb6ebf29a61954fcdd9 Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Sat, 15 Mar 2014 17:27:32 -0500
Subject: [PATCH 299/390] Remove undefined CONFIG_USE_USB_BUFFER_ALLOC_TX

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 hal/rtl8192du_xmit.c   | 21 +++++++--------------
 os_dep/usb_ops_linux.c | 14 ++++----------
 os_dep/xmit_linux.c    | 21 ++-------------------
 3 files changed, 13 insertions(+), 43 deletions(-)

--- a/drivers/staging/rtl8192du/hal/rtl8192du_xmit.c
+++ b/drivers/staging/rtl8192du/hal/rtl8192du_xmit.c
@@ -237,23 +237,18 @@ static s32 update_txdesc(struct xmit_fra
 	struct registry_priv	*pregistrypriv = &padapter->registrypriv;
 #endif /* CONFIG_P2P */
 
-#ifndef CONFIG_USE_USB_BUFFER_ALLOC_TX
-if (padapter->registrypriv.mp_mode == 0)
-{
+	if (padapter->registrypriv.mp_mode == 0) {
 
-	if ((false == bagg_pkt) && (urb_zero_packet_chk(padapter, sz)==0))
-	{
-		ptxdesc = (struct tx_desc *)(pmem+PACKET_OFFSET_SZ);
-		pull = 1;
-		pxmitframe->pkt_offset --;
+		if ((false == bagg_pkt) && (urb_zero_packet_chk(padapter, sz)==0)) {
+			ptxdesc = (struct tx_desc *)(pmem+PACKET_OFFSET_SZ);
+			pull = 1;
+			pxmitframe->pkt_offset --;
+		}
 	}
-}
-#endif	/*  CONFIG_USE_USB_BUFFER_ALLOC_TX */
 
 	memset(ptxdesc, 0, sizeof(struct tx_desc));
 
-	if ((pxmitframe->frame_tag&0x0f) == DATA_FRAMETAG)
-	{
+	if ((pxmitframe->frame_tag&0x0f) == DATA_FRAMETAG) {
 
 		/* offset 4 */
 		ptxdesc->txdw1 |= cpu_to_le32(pattrib->mac_id&0x1f);
@@ -711,7 +706,6 @@ s32 rtl8192du_xmitframe_complete(struct
 		rtw_issue_addbareq_cmd(padapter, pfirstframe);
 	}
 
-#ifndef CONFIG_USE_USB_BUFFER_ALLOC_TX
 	/* 3 3. update first frame txdesc */
 	if ((pbuf_tail % bulkSize) == 0) {
 		/*  remove 1 pkt_offset */
@@ -719,7 +713,6 @@ s32 rtl8192du_xmitframe_complete(struct
 		pfirstframe->buf_addr += PACKET_OFFSET_SZ;
 		pfirstframe->pkt_offset--;
 	}
-#endif	/*  CONFIG_USE_USB_BUFFER_ALLOC_TX */
 	update_txdesc(pfirstframe, pfirstframe->buf_addr, pfirstframe->attrib.last_txcmdsz, true);
 
 	/* 3 4. write xmit buffer to USB FIFO */
--- a/drivers/staging/rtl8192du/os_dep/usb_ops_linux.c
+++ b/drivers/staging/rtl8192du/os_dep/usb_ops_linux.c
@@ -290,16 +290,10 @@ u32 usb_write_port(struct intf_hdl *pint
 #endif
 
 	usb_fill_bulk_urb(purb, pusbd, pipe,
-				pxmitframe->buf_addr, /*  pxmitbuf->pbuf */
-				cnt,
-				usb_write_port_complete,
-				pxmitbuf);/* context is pxmitbuf */
-
-#ifdef CONFIG_USE_USB_BUFFER_ALLOC_TX
-	purb->transfer_dma = pxmitbuf->dma_transfer_addr;
-	purb->transfer_flags |= URB_NO_TRANSFER_DMA_MAP;
-	purb->transfer_flags |= URB_ZERO_PACKET;
-#endif	/*  CONFIG_USE_USB_BUFFER_ALLOC_TX */
+			  pxmitframe->buf_addr, /*  pxmitbuf->pbuf */
+			  cnt,
+			  usb_write_port_complete,
+			  pxmitbuf);/* context is pxmitbuf */
 
 	status = usb_submit_urb(purb, GFP_ATOMIC);
 	if (!status) {
--- a/drivers/staging/rtl8192du/os_dep/xmit_linux.c
+++ b/drivers/staging/rtl8192du/os_dep/xmit_linux.c
@@ -80,13 +80,6 @@ int rtw_os_xmit_resource_alloc(struct rt
 	struct dvobj_priv	*pdvobjpriv = adapter_to_dvobj(padapter);
 	struct usb_device	*pusbd = pdvobjpriv->pusbdev;
 
-#ifdef CONFIG_USE_USB_BUFFER_ALLOC_TX
-	pxmitbuf->pallocated_buf = rtw_usb_buffer_alloc(pusbd, (size_t)alloc_sz, GFP_ATOMIC, &pxmitbuf->dma_transfer_addr);
-	pxmitbuf->pbuf = pxmitbuf->pallocated_buf;
-	if (pxmitbuf->pallocated_buf == NULL)
-		return _FAIL;
-#else /*  CONFIG_USE_USB_BUFFER_ALLOC_TX */
-
 	pxmitbuf->pallocated_buf = kzalloc(alloc_sz, GFP_KERNEL);
 	if (pxmitbuf->pallocated_buf == NULL)
 	{
@@ -96,13 +89,9 @@ int rtw_os_xmit_resource_alloc(struct rt
 	pxmitbuf->pbuf = (u8 *)N_BYTE_ALIGMENT((SIZE_PTR)(pxmitbuf->pallocated_buf), XMITBUF_ALIGN_SZ);
 	pxmitbuf->dma_transfer_addr = 0;
 
-#endif /*  CONFIG_USE_USB_BUFFER_ALLOC_TX */
-
-	for (i=0; i<8; i++)
-	{
+	for (i=0; i < 8; i++) {
 		pxmitbuf->pxmit_urb[i] = usb_alloc_urb(0, GFP_KERNEL);
-		if (pxmitbuf->pxmit_urb[i] == NULL)
-		{
+		if (pxmitbuf->pxmit_urb[i] == NULL) {
 			DBG_8192D("pxmitbuf->pxmit_urb[i]==NULL");
 			return _FAIL;
 		}
@@ -125,13 +114,7 @@ void rtw_os_xmit_resource_free(struct rt
 		}
 	}
 
-#ifdef CONFIG_USE_USB_BUFFER_ALLOC_TX
-	rtw_usb_buffer_free(pusbd, (size_t)free_sz, pxmitbuf->pallocated_buf, pxmitbuf->dma_transfer_addr);
-	pxmitbuf->pallocated_buf =  NULL;
-	pxmitbuf->dma_transfer_addr = 0;
-#else	/*  CONFIG_USE_USB_BUFFER_ALLOC_TX */
 	kfree(pxmitbuf->pallocated_buf);
-#endif	/*  CONFIG_USE_USB_BUFFER_ALLOC_TX */
 }
 
 void rtw_os_pkt_complete(struct rtw_adapter *padapter, struct sk_buff *pkt)
