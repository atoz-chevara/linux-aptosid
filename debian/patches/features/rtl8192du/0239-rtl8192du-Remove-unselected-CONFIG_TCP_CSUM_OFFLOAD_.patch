From 9d7ca7161c5427edfcdc6a0276f675a2b79d99eb Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Thu, 20 Feb 2014 16:47:11 -0600
Subject: [PATCH 239/390] rtl8192du: Remove unselected
 CONFIG_TCP_CSUM_OFFLOAD_TX

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 hal/rtl8192du_xmit.c    | 13 +------------
 include/osdep_service.h |  6 +-----
 include/rtw_xmit.h      |  3 ---
 os_dep/mlme_linux.c     |  3 ---
 os_dep/os_intfs.c       |  3 ---
 os_dep/xmit_linux.c     | 26 --------------------------
 6 files changed, 2 insertions(+), 52 deletions(-)

--- a/drivers/staging/rtl8192du/hal/rtl8192du_xmit.c
+++ b/drivers/staging/rtl8192du/hal/rtl8192du_xmit.c
@@ -331,18 +331,7 @@ if (padapter->registrypriv.mp_mode == 0)
 			ptxdesc->txdw5 |= cpu_to_le32(BIT(2));/*  use OFDM 6Mbps */
 		}
 #endif /* CONFIG_P2P */
-
-		/* offset 24 */
-#ifdef CONFIG_TCP_CSUM_OFFLOAD_TX
-		if (pattrib->hw_tcp_csum == 1) {
-			u8 ip_hdr_offset = 32 + pattrib->hdrlen + pattrib->iv_len + 8;
-			ptxdesc->txdw7 = (1 << 31) | (ip_hdr_offset << 16);
-			DBG_8192D("ptxdesc->txdw7 = %08x\n", ptxdesc->txdw7);
-		}
-#endif
-	}
-	else if ((pxmitframe->frame_tag&0x0f)== MGNT_FRAMETAG)
-	{
+	} else if ((pxmitframe->frame_tag&0x0f)== MGNT_FRAMETAG) {
 
 		/* offset 4 */
 		ptxdesc->txdw1 |= cpu_to_le32(pattrib->mac_id&0x1f);
--- a/drivers/staging/rtl8192du/include/osdep_service.h
+++ b/drivers/staging/rtl8192du/include/osdep_service.h
@@ -57,15 +57,11 @@
 	#include <net/cfg80211.h>
 #endif /* CONFIG_IOCTL_CFG80211 */
 
-#ifdef CONFIG_TCP_CSUM_OFFLOAD_TX
-	#include <linux/in.h>
-	#include <linux/udp.h>
-#endif
-
 	#include <linux/usb.h>
 	#include <linux/usb/ch9.h>
 
 #define _mutex	struct mutex
+
 struct	__queue	{
 	struct	list_head	queue;
 	spinlock_t	lock;
--- a/drivers/staging/rtl8192du/include/rtw_xmit.h
+++ b/drivers/staging/rtl8192du/include/rtw_xmit.h
@@ -205,9 +205,6 @@ struct pkt_attrib
 	u8	intel_proxim;
 	u8	retry_ctrl;
 	struct sta_info * psta;
-#ifdef CONFIG_TCP_CSUM_OFFLOAD_TX
-	u8	hw_tcp_csum;
-#endif
 };
 
 #define WLANHDR_OFFSET	64
--- a/drivers/staging/rtl8192du/os_dep/mlme_linux.c
+++ b/drivers/staging/rtl8192du/os_dep/mlme_linux.c
@@ -364,9 +364,6 @@ int hostapd_mode_init(struct rtw_adapter
 
 	pnetdev->watchdog_timeo = HZ; /* 1 second timeout */
 
-#ifdef CONFIG_TCP_CSUM_OFFLOAD_TX
-	pnetdev->features |= NETIF_F_IP_CSUM;
-#endif
 	if (dev_alloc_name(pnetdev,"mgnt.wlan%d") < 0)
 		DBG_8192D("hostapd_mode_init(): dev_alloc_name, fail!\n");
 
--- a/drivers/staging/rtl8192du/os_dep/os_intfs.c
+++ b/drivers/staging/rtl8192du/os_dep/os_intfs.c
@@ -892,9 +892,6 @@ struct net_device *rtw_init_netdev(struc
 	DBG_8192D("register rtw_netdev_ops to netdev_ops\n");
 	pnetdev->netdev_ops = &rtw_netdev_ops;
 
-#ifdef CONFIG_TCP_CSUM_OFFLOAD_TX
-	pnetdev->features |= NETIF_F_IP_CSUM;
-#endif
 	pnetdev->watchdog_timeo = HZ*3; /* 3 second timeout */
 #ifdef CONFIG_WIRELESS_EXT
 	pnetdev->wireless_handlers = (struct iw_handler_def *)&rtw_handlers_def;
--- a/drivers/staging/rtl8192du/os_dep/xmit_linux.c
+++ b/drivers/staging/rtl8192du/os_dep/xmit_linux.c
@@ -72,32 +72,6 @@ int rtw_endofpktfile(struct pkt_file *pf
 
 void rtw_set_tx_chksum_offload(struct sk_buff *pkt, struct pkt_attrib *pattrib)
 {
-
-#ifdef CONFIG_TCP_CSUM_OFFLOAD_TX
-	struct sk_buff *skb = (struct sk_buff *)pkt;
-	pattrib->hw_tcp_csum = 0;
-
-	if (skb->ip_summed == CHECKSUM_PARTIAL) {
-		if (skb_shinfo(skb)->nr_frags == 0)
-		{
-                        const struct iphdr *ip = ip_hdr(skb);
-                        if (ip->protocol == IPPROTO_TCP) {
-                                /*  TCP checksum offload by HW */
-                                DBG_8192D("CHECKSUM_PARTIAL TCP\n");
-                                pattrib->hw_tcp_csum = 1;
-                                /* skb_checksum_help(skb); */
-                        } else if (ip->protocol == IPPROTO_UDP) {
-                                skb_checksum_help(skb);
-                        } else {
-				DBG_8192D("%s-%d TCP CSUM offload Error!!\n", __func__, __LINE__);
-                                WARN_ON(1);     /* we need a WARN() */
-			    }
-		} else { /*  IP fragmentation case */
-			DBG_8192D("%s-%d nr_frags != 0, using skb_checksum_help(skb);!!\n", __func__, __LINE__);
-			skb_checksum_help(skb);
-		}
-	}
-#endif
 }
 
 int rtw_os_xmit_resource_alloc(struct rtw_adapter *padapter, struct xmit_buf *pxmitbuf,u32 alloc_sz)
