From 7e948ef95e73560920f7a1eb9219c7c55da2fb56 Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Thu, 13 Mar 2014 18:03:49 -0500
Subject: [PATCH 252/390] Allow building with various combinations of
 configuration parameters

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 core/rtw_ap.c            | 19 +++----------
 core/rtw_ioctl_set.c     |  4 +--
 core/rtw_mlme.c          | 15 ++++-------
 core/rtw_mlme_ext.c      | 69 +++++++++++++++++-------------------------------
 core/rtw_sta_mgt.c       |  6 -----
 hal/hal_intf.c           |  2 +-
 hal/rtl8192du_xmit.c     |  6 ++---
 include/autoconf.h       |  4 ---
 include/ioctl_cfg80211.h |  2 --
 include/rtl8192d_xmit.h  |  2 +-
 include/rtw_ap.h         | 12 +++------
 include/rtw_mlme.h       |  6 +----
 include/rtw_mlme_ext.h   |  6 +----
 include/sta_info.h       | 11 --------
 os_dep/ioctl_cfg80211.c  |  3 ++-
 15 files changed, 46 insertions(+), 121 deletions(-)

--- a/drivers/staging/rtl8192du/core/rtw_ap.c
+++ b/drivers/staging/rtl8192du/core/rtw_ap.c
@@ -1350,8 +1350,6 @@ int rtw_acl_remove_sta(struct rtw_adapte
 	return ret;
 }
 
-#ifdef CONFIG_NATIVEAP_MLME
-
 static void update_bcn_fixed_ie(struct rtw_adapter *padapter)
 {
 	DBG_8192D("%s\n", __func__);
@@ -1875,19 +1873,9 @@ u8 ap_free_sta(struct rtw_adapter *padap
 	psta->state &= ~_FW_LINKED;
 	spin_unlock_bh(&psta->lock);
 
-	#ifdef CONFIG_IOCTL_CFG80211
-	if (1) {
-		#ifdef COMPAT_KERNEL_RELEASE
-		rtw_cfg80211_indicate_sta_disassoc(padapter, psta->hwaddr, reason);
-		#elif !defined(CONFIG_IOCTL_CFG80211)
-		rtw_cfg80211_indicate_sta_disassoc(padapter, psta->hwaddr,
-						   reason);
-		#endif
-	} else
-	#endif /* CONFIG_IOCTL_CFG80211 */
-	{
-		rtw_indicate_sta_disassoc_event(padapter, psta);
-	}
+#ifdef CONFIG_92D_AP_MODE
+	rtw_cfg80211_indicate_sta_disassoc(padapter, psta->hwaddr, reason);
+#endif /* CONFIG_IOCTL_CFG80211 */
 
 	report_del_sta_event(padapter, psta->hwaddr, reason);
 
@@ -2113,5 +2101,4 @@ void stop_ap_mode(struct rtw_adapter *pa
 	rtw_free_mlme_priv_ie_data(pmlmepriv);
 }
 
-#endif /* CONFIG_NATIVEAP_MLME */
 #endif /* CONFIG_92D_AP_MODE */
--- a/drivers/staging/rtl8192du/core/rtw_ioctl_set.c
+++ b/drivers/staging/rtl8192du/core/rtw_ioctl_set.c
@@ -374,7 +374,7 @@ u8 rtw_set_802_11_infrastructure_mode(st
 			/* change to other mode from Ndis802_11APMode */
 			cur_network->join_res = -1;
 
-#ifdef CONFIG_NATIVEAP_MLME
+#ifdef CONFIG_92D_AP_MODE
 			stop_ap_mode(padapter);
 #endif
 		}
@@ -404,7 +404,7 @@ u8 rtw_set_802_11_infrastructure_mode(st
 			break;
 		case NDIS802_11APMODE:
 			set_fwstate(pmlmepriv, WIFI_AP_STATE);
-#ifdef CONFIG_NATIVEAP_MLME
+#ifdef CONFIG_92D_AP_MODE
 			start_ap_mode(padapter);
 #endif
 			break;
--- a/drivers/staging/rtl8192du/core/rtw_mlme.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme.c
@@ -110,7 +110,7 @@ static void rtw_free_mlme_ie_data(u8 **p
 
 void rtw_free_mlme_priv_ie_data(struct mlme_priv *pmlmepriv)
 {
-#if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME)
+#if defined (CONFIG_92D_AP_MODE)
 	rtw_buf_free(&pmlmepriv->assoc_req, &pmlmepriv->assoc_req_len);
 	rtw_buf_free(&pmlmepriv->assoc_rsp, &pmlmepriv->assoc_rsp_len);
 	rtw_free_mlme_ie_data(&pmlmepriv->wps_beacon_ie,
@@ -1685,7 +1685,7 @@ void rtw_stassoc_event_callback(struct r
 	if (rtw_access_ctrl(adapter, pstassoc->macaddr) == false)
 		return;
 
-#if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME)
+#if defined (CONFIG_92D_AP_MODE)
 	if (check_fwstate(pmlmepriv, WIFI_AP_STATE)) {
 		psta = rtw_get_stainfo(&adapter->stapriv, pstassoc->macaddr);
 		if (psta) {
@@ -1789,15 +1789,10 @@ void rtw_stadel_event_callback(struct rt
 	struct wlan_network *tgt_network = &(pmlmepriv->cur_network);
 
 	if (check_fwstate(pmlmepriv, WIFI_AP_STATE)) {
-#ifdef CONFIG_IOCTL_CFG80211
-#ifdef COMPAT_KERNEL_RELEASE
-
-#elif defined(CONFIG_IOCTL_CFG80211)
+#if defined(CONFIG_92D_AP_MODE)
 		rtw_cfg80211_indicate_sta_disassoc(adapter, pstadel->macaddr,
 						   *(u16 *)pstadel->rsvd);
 #endif /* defined(CONFIG_IOCTL_CFG80211) */
-#endif /* CONFIG_IOCTL_CFG80211 */
-
 		return;
 	}
 
@@ -1999,9 +1994,9 @@ static void rtw_auto_scan_handler(struct
 
 void rtw_dynamic_check_timer_handlder(struct rtw_adapter *adapter)
 {
-#ifdef CONFIG_92D_AP_MODE
+#ifdef CONFIG_BR_EXT
 	struct mlme_priv *pmlmepriv = &adapter->mlmepriv;
-#endif /* CONFIG_92D_AP_MODE */
+#endif
 	struct registry_priv *pregistrypriv = &adapter->registrypriv;
 #ifdef CONFIG_CONCURRENT_MODE
 	struct rtw_adapter *pbuddy_adapter = adapter->pbuddy_adapter;
--- a/drivers/staging/rtl8192du/core/rtw_mlme_ext.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme_ext.c
@@ -45,7 +45,6 @@ static struct mlme_handler mlme_sta_tbl[
 	{WIFI_ACTION, "OnAction", &OnAction},
 };
 
-#ifdef _CONFIG_NATIVEAP_MLME_
 static struct mlme_handler mlme_ap_tbl[] = {
 	{WIFI_ASSOCREQ, "OnAssocReq", &OnAssocReq},
 	{WIFI_ASSOCRSP, "OnAssocRsp", &OnAssocRsp},
@@ -66,7 +65,6 @@ static struct mlme_handler mlme_ap_tbl[]
 	{WIFI_DEAUTH, "OnDeAuth", &OnDeAuth},
 	{WIFI_ACTION, "OnAction", &OnAction},
 };
-#endif
 
 static struct action_handler OnAction_tbl[] = {
 	{RTW_WLAN_CATEGORY_SPECTRUM_MGMT, "ACTION_SPECTRUM_MGMT",
@@ -1193,9 +1191,7 @@ unsigned int OnAuth(struct rtw_adapter *
 	/*  Now, we are going to issue_auth... */
 	pstat->auth_seq = seq + 1;
 
-#ifdef CONFIG_NATIVEAP_MLME
 	issue_auth(adapt, pstat, (unsigned short)(_STATS_SUCCESSFUL_));
-#endif
 
 	if (pstat->state & WIFI_FW_AUTH_SUCCESS)
 		pstat->auth_seq = 0;
@@ -1212,9 +1208,7 @@ auth_fail:
 	pstat->auth_seq = 2;
 	memcpy(pstat->hwaddr, sa, 6);
 
-#ifdef CONFIG_NATIVEAP_MLME
 	issue_auth(adapt, pstat, (unsigned short)status);
-#endif
 
 #endif
 	return _FAIL;
@@ -1776,7 +1770,6 @@ unsigned int OnAssocReq(struct rtw_adapt
 	/*  now the station is qualified to join our BSS... */
 	if (pstat && (pstat->state & WIFI_FW_ASSOC_SUCCESS) &&
 	    (_STATS_SUCCESSFUL_ == status)) {
-#ifdef CONFIG_NATIVEAP_MLME
 		/* 1 bss_cap_update & sta_info_update */
 		bss_cap_update_on_sta_join(adapt, pstat);
 		sta_info_update(adapt, pstat);
@@ -1791,10 +1784,6 @@ unsigned int OnAssocReq(struct rtw_adapt
 		DBG_8192D("indicate_sta_join_event to upper layer - hostapd\n");
 #ifdef CONFIG_IOCTL_CFG80211
 		if (1) {
-#ifdef COMPAT_KERNEL_RELEASE
-			rtw_cfg80211_indicate_sta_assoc(adapt, pframe,
-							pkt_len);
-#elif !defined(CONFIG_IOCTL_CFG80211)
 			rtw_cfg80211_indicate_sta_assoc(adapt, pframe,
 							pkt_len);
 #else /* !defined(CONFIG_IOCTL_CFG80211) */
@@ -1818,32 +1807,22 @@ unsigned int OnAssocReq(struct rtw_adapt
 
 		/* 3-(1) report sta add event */
 		report_add_sta_event(adapt, pstat->hwaddr, pstat->aid);
-
-#endif
 	}
 
 	return _SUCCESS;
 
 asoc_class2_error:
 
-#ifdef CONFIG_NATIVEAP_MLME
 	issue_deauth(adapt, (void *)GetAddr2Ptr(pframe), status);
-#endif
-
 	return _FAIL;
 
 OnAssocReqFail:
 
-#ifdef CONFIG_NATIVEAP_MLME
 	pstat->aid = 0;
 	if (frame_type == WIFI_ASSOCREQ)
 		issue_asocrsp(adapt, status, pstat, WIFI_ASSOCRSP);
 	else
 		issue_asocrsp(adapt, status, pstat, WIFI_REASSOCRSP);
-#endif
-
-#endif /* CONFIG_92D_AP_MODE */
-
 	return _FAIL;
 }
 
@@ -5810,9 +5789,9 @@ void issue_beacon(struct rtw_adapter *ad
 	unsigned short *fctrl;
 	unsigned int rate_len;
 	struct xmit_priv *pxmitpriv = &(adapt->xmitpriv);
-#if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME)
+#ifdef CONFIG_IOCTL_CFG80211
 	struct mlme_priv *pmlmepriv = &(adapt->mlmepriv);
-#endif /* if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME) */
+#endif
 	struct mlme_ext_priv *pmlmeext = &(adapt->mlmeextpriv);
 	struct mlme_ext_info *pmlmeinfo = &(pmlmeext->mlmext_info);
 	struct wlan_bssid_ex *cur_network = &(pmlmeinfo->network);
@@ -5826,9 +5805,9 @@ void issue_beacon(struct rtw_adapter *ad
 		DBG_8192D("%s, alloc mgnt frame fail\n", __func__);
 		return;
 	}
-#if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME)
+#if defined (CONFIG_92D_AP_MODE)
 	spin_lock_bh(&pmlmepriv->bcn_update_lock);
-#endif /* if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME) */
+#endif /* if defined (CONFIG_92D_AP_MODE) */
 
 	/* update attribute */
 	pattrib = &pmgntframe->attrib;
@@ -6103,11 +6082,11 @@ void issue_beacon(struct rtw_adapter *ad
 
 _issue_bcn:
 
-#if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME)
+#if defined (CONFIG_92D_AP_MODE)
 	pmlmepriv->update_bcn = false;
 
 	spin_unlock_bh(&pmlmepriv->bcn_update_lock);
-#endif /* if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME) */
+#endif /* if defined (CONFIG_92D_AP_MODE) */
 
 	if ((pattrib->pktlen + TXDESC_SIZE) > 512) {
 		DBG_8192D("beacon frame too large\n");
@@ -6131,11 +6110,13 @@ void issue_probersp(struct rtw_adapter *
 	unsigned short *fctrl;
 	unsigned char *mac, *bssid;
 	struct xmit_priv *pxmitpriv = &(adapt->xmitpriv);
-#if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME)
+#if defined (CONFIG_92D_AP_MODE)
 	u8 *pwps_ie;
 	uint wps_ielen;
+#endif /* if defined (CONFIG_92D_AP_MODE) */
+#ifdef CONFIG_IOCTL_CFG80211
 	struct mlme_priv *pmlmepriv = &adapt->mlmepriv;
-#endif /* if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME) */
+#endif
 	struct mlme_ext_priv *pmlmeext = &(adapt->mlmeextpriv);
 	struct mlme_ext_info *pmlmeinfo = &(pmlmeext->mlmext_info);
 	struct wlan_bssid_ex *cur_network = &(pmlmeinfo->network);
@@ -6181,7 +6162,7 @@ void issue_probersp(struct rtw_adapter *
 	if (cur_network->IELength > MAX_IE_SZ)
 		return;
 
-#if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME)
+#if defined (CONFIG_92D_AP_MODE)
 	if ((pmlmeinfo->state & 0x03) == WIFI_FW_AP_STATE) {
 		pwps_ie =
 		    rtw_get_wps_ie(cur_network->IEs + _FIXED_IE_LENGTH_,
@@ -6569,7 +6550,6 @@ void issue_auth(struct rtw_adapter *adap
 	pattrib->pktlen = sizeof(struct ieee80211_hdr_3addr);
 
 	if (psta) {		/*  for AP mode */
-#ifdef CONFIG_NATIVEAP_MLME
 		__le16 le_tmp16;
 
 		memcpy(pwlanhdr->addr1, psta->hwaddr, ETH_ALEN);
@@ -6584,9 +6564,8 @@ void issue_auth(struct rtw_adapter *adap
 		if (status != _STATS_SUCCESSFUL_)
 			val16 = 0;
 
-		if (val16) {
+		if (val16)
 			use_shared_key = 1;
-		}
 
 		le_tmp16 = cpu_to_le16(val16);
 		pframe =
@@ -6617,7 +6596,6 @@ void issue_auth(struct rtw_adapter *adap
 			    rtw_set_ie(pframe, _CHLGETXT_IE_, 128,
 				       psta->chg_txt, &(pattrib->pktlen));
 		}
-#endif
 	} else {
 		__le32 le_tmp32;
 		__le16 le_tmp16;
@@ -8237,12 +8215,11 @@ void site_survey(struct rtw_adapter *ada
 
 #ifdef CONFIG_P2P
 
-#ifdef CONFIG_CONCURRENT_MODE
-
-#ifdef CONFIG_STA_MODE_SCAN_UNDER_AP_MODE
+#ifdef CONFIG_92D_AP_MODE
 	u8 stay_buddy_ch = 0;
-#endif /* CONFIG_STA_MODE_SCAN_UNDER_AP_MODE */
+#endif
 
+#ifdef CONFIG_CONCURRENT_MODE
 	struct mlme_priv *pmlmepriv = &(adapt->mlmepriv);
 	struct rtw_adapter *pbuddy_adapter = adapt->pbuddy_adapter;
 	struct mlme_ext_priv *pbuddy_mlmeext = &pbuddy_adapter->mlmeextpriv;
@@ -8298,7 +8275,7 @@ void site_survey(struct rtw_adapter *ada
 	if (survey_channel != 0) {
 		/* PAUSE 4-AC Queue when site_survey */
 #ifdef CONFIG_CONCURRENT_MODE
-#ifdef CONFIG_STA_MODE_SCAN_UNDER_AP_MODE
+#ifdef CONFIG_92D_AP_MODE
 		if ((adapt->pbuddy_adapter->mlmeextpriv.mlmext_info.
 		     state & 0x03) == WIFI_FW_AP_STATE) {
 			if (pmlmeinfo->scan_cnt == RTW_SCAN_NUM_OF_CH) {
@@ -8322,7 +8299,7 @@ void site_survey(struct rtw_adapter *ada
 			SelectChannel(adapt, survey_channel);
 		}
 
-#ifdef CONFIG_STA_MODE_SCAN_UNDER_AP_MODE
+#ifdef CONFIG_92D_AP_MODE
 		if (stay_buddy_ch == 1) {
 			val8 = 0;	/* survey done */
 			rtw_hal_set_hwreg(adapt, HW_VAR_MLME_SITESURVEY,
@@ -8338,7 +8315,7 @@ void site_survey(struct rtw_adapter *ada
 			rtw_hal_set_hwreg(adapt, HW_VAR_MLME_SITESURVEY,
 					  (u8 *)(&val8));
 		}
-#endif /* CONFIG_STA_MODE_SCAN_UNDER_AP_MODE */
+#endif
 
 		if (ScanType == SCAN_ACTIVE) {	/* obey the channel plan setting... */
 #ifdef CONFIG_P2P
@@ -10111,9 +10088,6 @@ u8 setopmode_hdl(struct rtw_adapter *ada
 	if (psetop->mode == NDIS802_11APMODE) {
 		pmlmeinfo->state = WIFI_FW_AP_STATE;
 		type = _HW_STATE_AP_;
-#ifdef CONFIG_NATIVEAP_MLME
-		/* start_ap_mode(adapt); */
-#endif
 	} else if (psetop->mode == NDIS802_11INFRA) {
 		pmlmeinfo->state &= ~(BIT(0) | BIT(1));	/*  clear state */
 		pmlmeinfo->state |= WIFI_FW_STATION_STATE;	/* set to     STATION_STATE */
@@ -10930,13 +10904,17 @@ void change_band_update_ie(struct rtw_ad
 		network_type = WIRELESS_11A;
 		total_rate_len = IEEE80211_NUM_OFDM_RATESLEN;
 		DBG_8192D("%s(): change to 5G Band\n", __func__);
+#ifdef CONFIG_92D_AP_MODE
 		rtw_remove_bcn_ie(adapt, pnetwork, _ERPINFO_IE_);
+#endif
 	} else {
 		network_type = WIRELESS_11BG;
 		total_rate_len =
 		    IEEE80211_CCK_RATE_LEN + IEEE80211_NUM_OFDM_RATESLEN;
 		DBG_8192D("%s(): change to 2.4G Band\n", __func__);
+#ifdef CONFIG_92D_AP_MODE
 		rtw_add_bcn_ie(adapt, pnetwork, _ERPINFO_IE_, &erpinfo, 1);
+#endif
 	}
 
 	rtw_set_supported_rate(pnetwork->SupportedRates, network_type);
@@ -10953,9 +10931,9 @@ void change_band_update_ie(struct rtw_ad
 		remainder_rate_len = 0;
 	}
 
+#ifdef CONFIG_92D_AP_MODE
 	rtw_add_bcn_ie(adapt, pnetwork, _SUPPORTEDRATES_IE_,
 		       pnetwork->SupportedRates, rate_len);
-
 	if (remainder_rate_len) {
 		rtw_add_bcn_ie(adapt, pnetwork, _EXT_SUPPORTEDRATES_IE_,
 			       (pnetwork->SupportedRates + 8),
@@ -10963,6 +10941,7 @@ void change_band_update_ie(struct rtw_ad
 	} else {
 		rtw_remove_bcn_ie(adapt, pnetwork, _EXT_SUPPORTEDRATES_IE_);
 	}
+#endif
 }
 
 #ifdef CONFIG_DUALMAC_CONCURRENT
--- a/drivers/staging/rtl8192du/core/rtw_sta_mgt.c
+++ b/drivers/staging/rtl8192du/core/rtw_sta_mgt.c
@@ -53,14 +53,12 @@ static void _rtw_init_stainfo(struct sta
 
 	psta->bpairwise_key_installed = false;
 
-#ifdef CONFIG_NATIVEAP_MLME
 	psta->nonerp_set = 0;
 	psta->no_short_slot_time_set = 0;
 	psta->no_short_preamble_set = 0;
 	psta->no_ht_gf_set = 0;
 	psta->no_ht_set = 0;
 	psta->ht_20mhz_set = 0;
-#endif
 
 	psta->under_exist_checking = 0;
 	psta->keep_alive_trycnt = 0;
@@ -433,8 +431,6 @@ u32	rtw_free_stainfo(struct rtw_adapter
 
 	psta->has_legacy_ac = 0;
 
-#ifdef CONFIG_NATIVEAP_MLME
-
 	pstapriv->sta_dz_bitmap &= ~BIT(psta->aid);
 	pstapriv->tim_bitmap &= ~BIT(psta->aid);
 
@@ -443,8 +439,6 @@ u32	rtw_free_stainfo(struct rtw_adapter
 		psta->aid = 0;
 	}
 
-#endif	/*  CONFIG_NATIVEAP_MLME */
-
 	psta->under_exist_checking = 0;
 
 #endif	/*  CONFIG_92D_AP_MODE */
--- a/drivers/staging/rtl8192du/hal/hal_intf.c
+++ b/drivers/staging/rtl8192du/hal/hal_intf.c
@@ -322,7 +322,7 @@ void rtw_hal_bcn_related_reg_setting(str
 }
 
 #ifdef CONFIG_HOSTAPD_MLME
-s32	rtw_hal_hostap_mgnt_xmit_entry(struct rtw_adapter *padapter, _pkt *pkt)
+s32	rtw_hal_hostap_mgnt_xmit_entry(struct rtw_adapter *padapter, struct sk_buff *pkt)
 {
 	if (padapter->HalFunc.hostap_mgnt_xmit_entry)
 		return padapter->HalFunc.hostap_mgnt_xmit_entry(padapter, pkt);
--- a/drivers/staging/rtl8192du/hal/rtl8192du_xmit.c
+++ b/drivers/staging/rtl8192du/hal/rtl8192du_xmit.c
@@ -855,7 +855,7 @@ static void rtl8192du_hostap_mgnt_xmit_c
 	dev_kfree_skb_any(skb);
 }
 
-s32 rtl8192du_hostap_mgnt_xmit_entry(struct rtw_adapter *padapter, _pkt *pkt)
+s32 rtl8192du_hostap_mgnt_xmit_entry(struct rtw_adapter *padapter, struct sk_buff *pkt)
 {
 	u16 fc;
 	int rc, len, pipe;
@@ -872,8 +872,8 @@ s32 rtl8192du_hostap_mgnt_xmit_entry(str
 
 	skb = pkt;
 	len = skb->len;
-	tx_hdr = (struct ieee80211_hdr *)(skb->data);
-	fc = le16_to_cpu(tx_hdr->frame_ctl);
+	tx_hdr = (struct ieee80211_3ddr_hdr *)(skb->data);
+	fc = le16_to_cpu(tx_hdr->frame_control);
 	bmcst = IS_MCAST(tx_hdr->addr1);
 
 	if ((fc & RTW_IEEE80211_FCTL_FTYPE) != RTW_IEEE80211_FTYPE_MGMT)
--- a/drivers/staging/rtl8192du/include/autoconf.h
+++ b/drivers/staging/rtl8192du/include/autoconf.h
@@ -38,10 +38,6 @@
 #define CONFIG_RECV_REORDERING_CTRL	1
 
 #define CONFIG_92D_AP_MODE 1
-#define CONFIG_NATIVEAP_MLME 1
-#ifndef CONFIG_NATIVEAP_MLME
-	#define CONFIG_HOSTAPD_MLME	1
-#endif
 #define CONFIG_FIND_BEST_CHANNEL	1
 
 #define CONFIG_P2P	1
--- a/drivers/staging/rtl8192du/include/ioctl_cfg80211.h
+++ b/drivers/staging/rtl8192du/include/ioctl_cfg80211.h
@@ -89,10 +89,8 @@ void rtw_cfg80211_indicate_connect(struc
 void rtw_cfg80211_indicate_disconnect(struct rtw_adapter *padapter);
 void rtw_cfg80211_indicate_scan_done(struct rtw_wdev_priv *pwdev_priv, bool aborted);
 
-#ifdef CONFIG_92D_AP_MODE
 void rtw_cfg80211_indicate_sta_assoc(struct rtw_adapter *padapter, u8 *pmgmt_frame, uint frame_len);
 void rtw_cfg80211_indicate_sta_disassoc(struct rtw_adapter *padapter, unsigned char *da, unsigned short reason);
-#endif /* CONFIG_92D_AP_MODE */
 
 void rtw_cfg80211_issue_p2p_provision_request(struct rtw_adapter *padapter, const u8 *buf, size_t len);
 void rtw_cfg80211_rx_p2p_action_public(struct rtw_adapter *padapter, u8 *pmgmt_frame, uint frame_len);
--- a/drivers/staging/rtl8192du/include/rtl8192d_xmit.h
+++ b/drivers/staging/rtl8192du/include/rtl8192d_xmit.h
@@ -102,7 +102,7 @@ s32 rtl8192du_hal_xmit(struct rtw_adapte
 		       struct xmit_frame *pxmitframe);
 
 #ifdef CONFIG_HOSTAPD_MLME
-s32	rtl8192du_hostap_mgnt_xmit_entry(struct rtw_adapter *padapter, _pkt *pkt);
+s32	rtl8192du_hostap_mgnt_xmit_entry(struct rtw_adapter *padapter, struct sk_buff *pkt);
 #endif
 
 #endif
--- a/drivers/staging/rtl8192du/include/rtw_ap.h
+++ b/drivers/staging/rtl8192du/include/rtw_ap.h
@@ -20,13 +20,8 @@
 #include <osdep_service.h>
 #include <drv_types.h>
 
-
-#ifdef CONFIG_92D_AP_MODE
-
-/* external function */
-extern void rtw_indicate_sta_assoc_event(struct rtw_adapter *padapter, struct sta_info *psta);
-extern void rtw_indicate_sta_disassoc_event(struct rtw_adapter *padapter, struct sta_info *psta);
-
+void rtw_indicate_sta_assoc_event(struct rtw_adapter *padapter, struct sta_info *psta);
+void rtw_indicate_sta_disassoc_event(struct rtw_adapter *padapter, struct sta_info *psta);
 
 void init_mlme_ap_info(struct rtw_adapter *padapter);
 void free_mlme_ap_info(struct rtw_adapter *padapter);
@@ -40,7 +35,7 @@ void rtw_set_macaddr_acl(struct rtw_adap
 int rtw_acl_add_sta(struct rtw_adapter *padapter, u8 *addr);
 int rtw_acl_remove_sta(struct rtw_adapter *padapter, u8 *addr);
 
-#ifdef CONFIG_NATIVEAP_MLME
+#ifdef CONFIG_92D_AP_MODE
 void associated_clients_update(struct rtw_adapter *padapter, u8 updated);
 void bss_cap_update_on_sta_join(struct rtw_adapter *padapter, struct sta_info *psta);
 u8 bss_cap_update_on_sta_leave(struct rtw_adapter *padapter, struct sta_info *psta);
@@ -51,7 +46,6 @@ int rtw_sta_flush(struct rtw_adapter *pa
 int rtw_ap_inform_ch_switch (struct rtw_adapter *padapter, u8 new_ch, u8 ch_offset);
 void start_ap_mode(struct rtw_adapter *padapter);
 void stop_ap_mode(struct rtw_adapter *padapter);
-#endif
 #endif /* end of CONFIG_92D_AP_MODE */
 
 #endif
--- a/drivers/staging/rtl8192du/include/rtw_mlme.h
+++ b/drivers/staging/rtl8192du/include/rtw_mlme.h
@@ -384,7 +384,6 @@ struct mlme_priv {
 	u8 *wps_probe_req_ie;
 	u32 wps_probe_req_ie_len;
 
-#if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME)
 	/* Number of associated Non-ERP stations (i.e., stations using 802.11b
 	 * in 802.11g BSS) */
 	int num_sta_non_erp;
@@ -437,9 +436,6 @@ struct mlme_priv {
 	spinlock_t	bcn_update_lock;
 	u8		update_bcn;
 
-
-#endif /* if defined (CONFIG_92D_AP_MODE) && defined (CONFIG_NATIVEAP_MLME) */
-
 #ifdef CONFIG_CONCURRENT_MODE
 	u8	scanning_via_buddy_intf;
 #endif
@@ -546,8 +542,8 @@ __inline static void up_scanned_network(
 
 #ifdef CONFIG_CONCURRENT_MODE
 int rtw_buddy_adapter_up(struct rtw_adapter *padapter);
-int check_buddy_fwstate(struct rtw_adapter *padapter, int state);
 #endif /* CONFIG_CONCURRENT_MODE */
+int check_buddy_fwstate(struct rtw_adapter *padapter, int state);
 
 __inline static void down_scanned_network(struct mlme_priv *pmlmepriv)
 {
--- a/drivers/staging/rtl8192du/include/rtw_mlme_ext.h
+++ b/drivers/staging/rtl8192du/include/rtw_mlme_ext.h
@@ -419,11 +419,7 @@ struct mlme_ext_priv
 	u32	retry; /* retry for issue probereq */
 
 	u64 TSFValue;
-
-#ifdef CONFIG_92D_AP_MODE
 	unsigned char bstart_bss;
-#endif
-
 	/* recv_decache check for Action_public frame */
         u8 action_public_dialog_token;
 	u16	 action_public_rxseq;
@@ -625,8 +621,8 @@ extern void update_TSF(struct mlme_ext_p
 extern void correct_TSF(struct rtw_adapter *padapter, struct mlme_ext_priv *pmlmeext);
 
 
-#ifdef CONFIG_CONCURRENT_MODE
 int check_buddy_mlmeinfo_state(struct rtw_adapter *padapter, u32 state);
+#ifdef CONFIG_CONCURRENT_MODE
 int concurrent_chk_start_clnt_join(struct rtw_adapter *padapter);
 void concurrent_chk_joinbss_done(struct rtw_adapter *padapter, int join_res);
 #endif /* CONFIG_CONCURRENT_MODE */
--- a/drivers/staging/rtl8192du/include/sta_info.h
+++ b/drivers/staging/rtl8192du/include/sta_info.h
@@ -138,8 +138,6 @@ struct sta_info {
 	/* curr_network(mlme_priv/security_priv/qos/ht) : AP CAP/INFO */
 	/* sta_info: (AP & STA) CAP/INFO */
 
-#ifdef CONFIG_92D_AP_MODE
-
 	struct list_head asoc_list;
 	struct list_head auth_list;
 
@@ -160,7 +158,6 @@ struct sta_info {
 
 	u8 bpairwise_key_installed;
 
-#ifdef CONFIG_NATIVEAP_MLME
 	u8 wpa_ie[32];
 
 	u8 nonerp_set;
@@ -169,7 +166,6 @@ struct sta_info {
 	u8 no_ht_gf_set;
 	u8 no_ht_set;
 	u8 ht_20mhz_set;
-#endif	/*  CONFIG_NATIVEAP_MLME */
 
 	unsigned int tx_ra_bitmap;
 	u8 qos_info;
@@ -203,8 +199,6 @@ struct sta_info {
 
 	u8 keep_alive_trycnt;
 
-#endif	/*  CONFIG_92D_AP_MODE */
-
 #ifdef CONFIG_IOCTL_CFG80211
 	u8 *passoc_req;
 	u32 assoc_req_len;
@@ -299,7 +293,6 @@ struct sta_info {
 #define STA_PKTS_FMT "(m:%llu, c:%llu, d:%llu)"
 
 struct	sta_priv {
-
 	u8 *pallocated_stainfo_buf;
 	u8 *pstainfo_buf;
 	struct __queue free_sta_queue;
@@ -312,8 +305,6 @@ struct	sta_priv {
 
 	struct rtw_adapter *padapter;
 
-
-#ifdef CONFIG_92D_AP_MODE
 	struct list_head asoc_list;
 	struct list_head auth_list;
 	spinlock_t asoc_list_lock;
@@ -337,8 +328,6 @@ struct	sta_priv {
 	u16 max_num_sta;
 
 	struct wlan_acl_pool acl_list;
-#endif
-
 };
 
 
--- a/drivers/staging/rtl8192du/os_dep/ioctl_cfg80211.c
+++ b/drivers/staging/rtl8192du/os_dep/ioctl_cfg80211.c
@@ -3877,8 +3877,9 @@ static int rtw_cfg80211_set_beacon_wpsp2
 			memcpy(pmlmepriv->wps_beacon_ie, wps_ie, wps_ielen);
 			pmlmepriv->wps_beacon_ie_len = wps_ielen;
 
+#ifdef CONFIG_92D_AP_MODE
 			update_beacon(padapter, _VENDOR_SPECIFIC_IE_, wps_oui, true);
-
+#endif
 		}
 
 		#ifdef CONFIG_P2P
