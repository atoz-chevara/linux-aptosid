From 1a720d6f29ff83ff87aa04d576a8b68e15e180bc Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Wed, 17 Apr 2013 17:32:10 -0500
Subject: [PATCH 026/390] Remove more cose associated with CONFIG_XXX_HDA

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 core/rtw_ap.c         | 20 ---------------
 core/rtw_ioctl_set.c  |  6 -----
 core/rtw_iol.c        | 19 --------------
 core/rtw_mlme.c       |  5 ----
 core/rtw_mlme_ext.c   | 37 +++------------------------
 core/rtw_pwrctrl.c    | 16 ------------
 core/rtw_xmit.c       | 55 ----------------------------------------
 hal/rtl8192d_cmd.c    |  7 ------
 hal/rtl8192d_rxdesc.c | 69 ---------------------------------------------------
 9 files changed, 3 insertions(+), 231 deletions(-)

--- a/drivers/staging/rtl8192du/core/rtw_ap.c
+++ b/drivers/staging/rtl8192du/core/rtw_ap.c
@@ -199,9 +199,7 @@ static void update_BCNTIM(_adapter *pada
 	}
 
 #ifndef CONFIG_INTERRUPT_BASED_TXBCN
-#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI) || defined(CONFIG_GSPI_HCI)
 	set_tx_beacon_cmd(padapter);
-#endif
 #endif //!CONFIG_INTERRUPT_BASED_TXBCN
 
 
@@ -1330,23 +1328,15 @@ static void start_bss_network(_adapter *
 		update_beacon(padapter, _TIM_IE_, NULL, _FALSE);
 
 #ifndef CONFIG_INTERRUPT_BASED_TXBCN //other case will  tx beacon when bcn interrupt coming in.
-#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI) || defined(CONFIG_GSPI_HCI)
 		//issue beacon frame
 		if(send_beacon(padapter)==_FAIL)
-		{
 			DBG_871X("issue_beacon, fail!\n");
-		}
-#endif
 #endif //!CONFIG_INTERRUPT_BASED_TXBCN
 
 	}
 
-
 	//update bc/mc sta_info
 	update_bmc_sta(padapter);
-
-	//pmlmeext->bstart_bss = _TRUE;
-
 }
 
 int rtw_check_beacon_data(_adapter *padapter, u8 *pbuf,  int len)
@@ -2121,19 +2111,9 @@ void update_beacon(_adapter *padapter, u
 	_exit_critical_bh(&pmlmepriv->bcn_update_lock, &irqL);
 
 #ifndef CONFIG_INTERRUPT_BASED_TXBCN
-#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI) || defined(CONFIG_GSPI_HCI)
 	if(tx)
-	{
-		//send_beacon(padapter);//send_beacon must execute on TSR level
 		set_tx_beacon_cmd(padapter);
-	}
-#else
-	{
-		//PCI will issue beacon when BCN interrupt occurs.
-	}
-#endif
 #endif //!CONFIG_INTERRUPT_BASED_TXBCN
-
 }
 
 #ifdef CONFIG_80211N_HT
--- a/drivers/staging/rtl8192du/core/rtw_ioctl_set.c
+++ b/drivers/staging/rtl8192du/core/rtw_ioctl_set.c
@@ -25,14 +25,8 @@
 #include <drv_types.h>
 #include <rtw_ioctl_set.h>
 #include <hal_intf.h>
-
-#ifdef CONFIG_USB_HCI
 #include <usb_osintf.h>
 #include <usb_ops.h>
-#endif
-#ifdef CONFIG_SDIO_HCI
-#include <sdio_osintf.h>
-#endif
 
 extern void indicate_wx_scan_complete_event(_adapter *padapter);
 
--- a/drivers/staging/rtl8192du/core/rtw_iol.c
+++ b/drivers/staging/rtl8192du/core/rtw_iol.c
@@ -78,12 +78,7 @@ int rtw_IOL_append_cmds(struct xmit_fram
 	u32 ori_len;
 
 //Todo: bulkout without this offset
-#ifdef CONFIG_USB_HCI
 	buf_offset = TXDESC_OFFSET;
-#else
-	buf_offset = 0;
-#endif
-
 	ori_len = buf_offset+pattrib->pktlen;
 
 	//check if the io_buf can accommodate new cmds
@@ -96,9 +91,6 @@ int rtw_IOL_append_cmds(struct xmit_fram
 	_rtw_memcpy(xmit_frame->buf_addr + buf_offset + pattrib->pktlen, IOL_cmds, cmd_len);
 	pattrib->pktlen += cmd_len;
 	pattrib->last_txcmdsz += cmd_len;
-
-	//DBG_871X("%s ori:%u + cmd_len:%u = %u\n", __FUNCTION__, ori_len, cmd_len, buf_offset+pattrib->pktlen);
-
 	return _SUCCESS;
 }
 
@@ -198,12 +190,7 @@ int rtw_IOL_append_END_cmd(struct xmit_f
 	IOL_CMD end_cmd = {0x0, IOL_CMD_END, 0x0, 0x0};
 
 //Todo: bulkout without this offset
-#ifdef CONFIG_USB_HCI
 	buf_offset = TXDESC_OFFSET;
-#else
-	buf_offset = 0;
-#endif
-
 	ori_len = buf_offset+pattrib->pktlen;
 
 	//check if the io_buf can accommodate new cmds
@@ -217,8 +204,6 @@ int rtw_IOL_append_END_cmd(struct xmit_f
 	pattrib->pktlen += 8;
 	pattrib->last_txcmdsz += 8;
 
-	//DBG_871X("%s ori:%u + 8 = %u\n", __FUNCTION__ , ori_len, buf_offset+pattrib->pktlen);
-
 	return _SUCCESS;
 }
 
@@ -250,12 +235,8 @@ bool rtw_IOL_applied(ADAPTER *adapter)
 {
 	if(adapter->registrypriv.force_iol)
 		return _TRUE;
-
-#ifdef CONFIG_USB_HCI
 	if(!adapter_to_dvobj(adapter)->ishighspeed)
 		return _TRUE;
-#endif
-
 	return _FALSE;
 }
 
--- a/drivers/staging/rtl8192du/core/rtw_mlme.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme.c
@@ -3031,7 +3031,6 @@ void rtw_joinbss_reset(_adapter *padapte
 
 	phtpriv->ampdu_enable = _FALSE;//reset to disabled
 
-#ifdef CONFIG_USB_HCI
 	// TH=1 => means that invalidate usb rx aggregation
 	// TH=0 => means that validate usb rx aggregation, use init value.
 	if(phtpriv->ht_option)
@@ -3048,12 +3047,8 @@ void rtw_joinbss_reset(_adapter *padapte
 		rtw_hal_set_hwreg(padapter, HW_VAR_RXDMA_AGG_PG_TH, (u8 *)(&threshold));
 	}
 #endif
-
-#endif
-
 }
 
-
 #ifdef CONFIG_80211N_HT
 
 //the fucntion is >= passive_level
--- a/drivers/staging/rtl8192du/core/rtw_mlme_ext.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme_ext.c
@@ -8359,24 +8359,7 @@ unsigned int send_beacon(_adapter *padap
 	u8	bxmitok = _FALSE;
 	int	issue=0;
 	int poll = 0;
-//#ifdef CONFIG_CONCURRENT_MODE
-	//struct mlme_ext_priv	*pmlmeext = &(padapter->mlmeextpriv);
-	//struct mlme_ext_info	*pmlmeinfo = &(pmlmeext->mlmext_info);
-	//_adapter *pbuddy_adapter = padapter->pbuddy_adapter;
-	//struct mlme_priv *pbuddy_mlmepriv = &(pbuddy_adapter->mlmepriv);
-//#endif
-
-#ifdef CONFIG_PCI_HCI
-
-	//DBG_871X("%s\n", __FUNCTION__);
-
-	issue_beacon(padapter);
-
-	return _SUCCESS;
-
-#endif
 
-#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI) || defined(CONFIG_GSPI_HCI)
 	u32 start = rtw_get_current_time();
 
 	rtw_hal_set_hwreg(padapter, HW_VAR_BCN_VALID, NULL);
@@ -8392,28 +8375,17 @@ unsigned int send_beacon(_adapter *padap
 	}while(_FALSE == bxmitok && issue<100 && !padapter->bSurpriseRemoved && !padapter->bDriverStopped);
 
 	if(padapter->bSurpriseRemoved || padapter->bDriverStopped)
-	{
 		return _FAIL;
-	}
-	if(_FALSE == bxmitok)
-	{
+	if(_FALSE == bxmitok) {
 		DBG_871X("%s fail! %u ms\n", __FUNCTION__, rtw_get_passing_time_ms(start));
 		return _FAIL;
-	}
-	else
-	{
+	} else {
 		u32 passing_time = rtw_get_passing_time_ms(start);
 
 		if(passing_time > 100 || issue > 3)
 			DBG_871X("%s success, issue:%d, poll:%d, %u ms\n", __FUNCTION__, issue, poll, rtw_get_passing_time_ms(start));
-		//else
-		//	DBG_871X("%s success, issue:%d, poll:%d, %u ms\n", __FUNCTION__, issue, poll, rtw_get_passing_time_ms(start));
-
 		return _SUCCESS;
 	}
-
-#endif
-
 }
 
 /****************************************************************************
@@ -11253,11 +11225,8 @@ u8 tx_beacon_hdl(_adapter *padapter, uns
 		if(!psta_bmc)
 			return H2C_SUCCESS;
 
-		if((pstapriv->tim_bitmap&BIT(0)) && (psta_bmc->sleepq_len>0))
-		{
-#ifndef CONFIG_PCI_HCI
+		if((pstapriv->tim_bitmap&BIT(0)) && (psta_bmc->sleepq_len>0)) {
 			rtw_msleep_os(10);// 10ms, ATIM(HIQ) Windows
-#endif
 			_enter_critical_bh(&psta_bmc->sleep_q.lock, &irqL);
 
 			xmitframe_phead = get_list_head(&psta_bmc->sleep_q);
--- a/drivers/staging/rtl8192du/core/rtw_pwrctrl.c
+++ b/drivers/staging/rtl8192du/core/rtw_pwrctrl.c
@@ -1132,20 +1132,14 @@ _func_exit_;
 }
 
 #ifdef CONFIG_RESUME_IN_WORKQUEUE
-#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI)
 extern int rtw_resume_process(_adapter *padapter);
-#endif
 static void resume_workitem_callback(struct work_struct *work)
 {
 	struct pwrctrl_priv *pwrpriv = container_of(work, struct pwrctrl_priv, resume_work);
 	_adapter *adapter = container_of(pwrpriv, _adapter, pwrctrlpriv);
 
 	DBG_871X("%s\n",__FUNCTION__);
-
-	#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI)
 	rtw_resume_process(adapter);
-	#endif
-
 }
 
 void rtw_resume_in_workqueue(struct pwrctrl_priv *pwrpriv)
@@ -1179,9 +1173,7 @@ inline void rtw_set_do_late_resume(struc
 #endif
 
 #ifdef CONFIG_HAS_EARLYSUSPEND
-#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI)
 extern int rtw_resume_process(_adapter *padapter);
-#endif
 static void rtw_early_suspend(struct early_suspend *h)
 {
 	struct pwrctrl_priv *pwrpriv = container_of(h, struct pwrctrl_priv, early_suspend);
@@ -1197,10 +1189,8 @@ static void rtw_late_resume(struct early
 
 	DBG_871X("%s\n",__FUNCTION__);
 	if(pwrpriv->do_late_resume) {
-		#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI)
 		rtw_set_do_late_resume(pwrpriv, _FALSE);
 		rtw_resume_process(adapter);
-		#endif
 	}
 }
 
@@ -1232,9 +1222,7 @@ void rtw_unregister_early_suspend(struct
 #endif //CONFIG_HAS_EARLYSUSPEND
 
 #ifdef CONFIG_ANDROID_POWER
-#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI)
 extern int rtw_resume_process(PADAPTER padapter);
-#endif
 static void rtw_early_suspend(android_early_suspend_t *h)
 {
 	struct pwrctrl_priv *pwrpriv = container_of(h, struct pwrctrl_priv, early_suspend);
@@ -1250,10 +1238,8 @@ static void rtw_late_resume(android_earl
 
 	DBG_871X("%s\n",__FUNCTION__);
 	if(pwrpriv->do_late_resume) {
-		#if defined(CONFIG_USB_HCI) || defined(CONFIG_SDIO_HCI)
 		rtw_set_do_late_resume(pwrpriv, _FALSE);
 		rtw_resume_process(adapter);
-		#endif
 	}
 }
 
@@ -1370,7 +1356,6 @@ int _rtw_pwr_wakeup(_adapter *padapter,
 
 	if(rf_off == pwrpriv->rf_pwrstate )
 	{
-#ifdef CONFIG_USB_HCI
 #ifdef CONFIG_AUTOSUSPEND
 		 if(pwrpriv->brfoffbyhw==_TRUE)
 		{
@@ -1390,7 +1375,6 @@ int _rtw_pwr_wakeup(_adapter *padapter,
 		}
 		else
 #endif
-#endif
 		{
 #ifdef CONFIG_IPS
 			DBG_8192C("%s call ips_leave....\n",__FUNCTION__);
--- a/drivers/staging/rtl8192du/core/rtw_xmit.c
+++ b/drivers/staging/rtl8192du/core/rtw_xmit.c
@@ -189,13 +189,6 @@ _func_enter_;
 			goto exit;
 		}
 
-#ifdef CONFIG_SDIO_HCI
-		pxmitbuf->phead = pxmitbuf->pbuf;
-		pxmitbuf->pend = pxmitbuf->pbuf + MAX_XMITBUF_SZ;
-		pxmitbuf->len = 0;
-		pxmitbuf->pdata = pxmitbuf->ptail = pxmitbuf->phead;
-#endif
-
 		pxmitbuf->flags = XMIT_VO_QUEUE;
 
 		rtw_list_insert_tail(&pxmitbuf->list, &(pxmitpriv->free_xmitbuf_queue.queue));
@@ -248,13 +241,6 @@ _func_enter_;
 			goto exit;
 		}
 
-#ifdef CONFIG_SDIO_HCI
-		pxmitbuf->phead = pxmitbuf->pbuf;
-		pxmitbuf->pend = pxmitbuf->pbuf + MAX_XMIT_EXTBUF_SZ;
-		pxmitbuf->len = 0;
-		pxmitbuf->pdata = pxmitbuf->ptail = pxmitbuf->phead;
-#endif
-
 		rtw_list_insert_tail(&pxmitbuf->list, &(pxmitpriv->free_xmit_extbuf_queue.queue));
 		#ifdef DBG_XMIT_BUF
 		pxmitbuf->no=i;
@@ -268,7 +254,6 @@ _func_enter_;
 	rtw_alloc_hwxmits(padapter);
 	rtw_init_hwxmits(pxmitpriv->hwxmits, pxmitpriv->hwxmit_entry);
 
-#ifdef CONFIG_USB_HCI
 	pxmitpriv->txirp_cnt=1;
 
 	_rtw_init_sema(&(pxmitpriv->tx_retevt), 0);
@@ -278,8 +263,6 @@ _func_enter_;
 	pxmitpriv->bkq_cnt = 0;
 	pxmitpriv->viq_cnt = 0;
 	pxmitpriv->voq_cnt = 0;
-#endif
-
 
 #ifdef CONFIG_XMIT_ACK
 	pxmitpriv->ack_tx = _FALSE;
@@ -1895,14 +1878,6 @@ _func_enter_;
 
 		pxmitbuf->priv_data = NULL;
 
-#ifdef CONFIG_SDIO_HCI
-		pxmitbuf->len = 0;
-		pxmitbuf->pdata = pxmitbuf->ptail = pxmitbuf->phead;
-#endif
-#ifdef CONFIG_PCI_HCI
-		pxmitbuf->len = 0;
-#endif
-
 		if (pxmitbuf->sctx) {
 			DBG_871X("%s pxmitbuf->sctx is not NULL\n", __func__);
 			rtw_sctx_done_err(&pxmitbuf->sctx, RTW_SCTX_DONE_BUF_ALLOC);
@@ -1982,14 +1957,6 @@ _func_enter_;
 
 		pxmitbuf->priv_data = NULL;
 
-#ifdef CONFIG_SDIO_HCI
-		pxmitbuf->len = 0;
-		pxmitbuf->pdata = pxmitbuf->ptail = pxmitbuf->phead;
-#endif
-#ifdef CONFIG_PCI_HCI
-		pxmitbuf->len = 0;
-#endif
-
 		if (pxmitbuf->sctx) {
 			DBG_871X("%s pxmitbuf->sctx is not NULL\n", __func__);
 			rtw_sctx_done_err(&pxmitbuf->sctx, RTW_SCTX_DONE_BUF_ALLOC);
@@ -2110,7 +2077,6 @@ _func_enter_;
 
 		pxframe->frame_tag = DATA_FRAMETAG;
 
-#ifdef CONFIG_USB_HCI
 		pxframe->pkt = NULL;
 		pxframe->pkt_offset = 1;//default use pkt_offset to fill tx desc
 
@@ -2118,13 +2084,6 @@ _func_enter_;
 		pxframe->agg_num = 1;
 #endif
 
-#endif //#ifdef CONFIG_USB_HCI
-
-#ifdef CONFIG_SDIO_HCI
-		pxframe->pg_num = 1;
-		pxframe->agg_num = 1;
-#endif
-
 #if (LINUX_VERSION_CODE < KERNEL_VERSION(2,6,35))
 		if(pxmitpriv->free_xmitframe_cnt==1)
 		{
@@ -2266,9 +2225,6 @@ struct xmit_frame* rtw_dequeue_xframe(st
 	_adapter *padapter = pxmitpriv->adapter;
 	struct registry_priv	*pregpriv = &padapter->registrypriv;
 	int i, inx[4];
-#ifdef CONFIG_USB_HCI
-//	int j, tmp, acirp_cnt[4];
-#endif
 
 _func_enter_;
 
@@ -2277,16 +2233,6 @@ _func_enter_;
 	if(pregpriv->wifi_spec==1)
 	{
 		int j, tmp, acirp_cnt[4];
-#if 0
-		if(flags<XMIT_QUEUE_ENTRY)
-		{
-			//priority exchange according to the completed xmitbuf flags.
-			inx[flags] = 0;
-			inx[0] = flags;
-		}
-#endif
-
-#ifdef CONFIG_USB_HCI
 		//entry indx: 0->vo, 1->vi, 2->be, 3->bk.
 		acirp_cnt[0] = pxmitpriv->voq_cnt;
 		acirp_cnt[1] = pxmitpriv->viq_cnt;
@@ -2309,7 +2255,6 @@ _func_enter_;
 				}
 			}
 		}
-#endif
 	}
 
 	_enter_critical_bh(&pxmitpriv->lock, &irqL0);
--- a/drivers/staging/rtl8192du/hal/rtl8192d_cmd.c
+++ b/drivers/staging/rtl8192du/hal/rtl8192d_cmd.c
@@ -663,11 +663,9 @@ FillFakeTxDescriptor92D(
 	if(pHalData->CurrentBandType92D == BAND_ON_5G)
 		ptxdesc->txdw5 |= cpu_to_le32(BIT(2));// use OFDM 6Mbps
 
-#ifdef CONFIG_USB_HCI
 	// USB interface drop packet if the checksum of descriptor isn't correct.
 	// Using this checksum can let hardware recovery from packet bulk out error (e.g. Cancel URC, Bulk out error.).
 	rtl8192du_cal_txdesc_chksum(ptxdesc);
-#endif
 
 	RT_PRINT_DATA(_module_rtl8712_cmd_c_, _drv_info_, "FillFakeTxDescriptor92D(): H2C Tx Desc Content ----->\n", pDesc, TXDESC_SIZE);
 }
@@ -712,13 +710,8 @@ void SetFwRsvdPagePkt(PADAPTER Adapter,
 
 	TxDescLen = 32;//TX_DESC_SIZE;
 
-#ifdef CONFIG_USB_HCI
 	BufIndex = TXDESC_OFFSET;
 	TxDescOffset = TxDescLen+8; //Shift index for 8 bytes because the dummy bytes in the first descipstor.
-#else
-	BufIndex = 0;
-	TxDescOffset = 0;
-#endif
 
 	//(1) beacon
 	ConstructBeacon(Adapter,&ReservedPagePacket[BufIndex],&BeaconLength);
--- a/drivers/staging/rtl8192du/hal/rtl8192d_rxdesc.c
+++ b/drivers/staging/rtl8192du/hal/rtl8192d_rxdesc.c
@@ -54,94 +54,25 @@ static s32 signal_scale_mapping(_adapter
 {
 	s32 ret_sig;
 
-#ifdef CONFIG_USB_HCI
 	if(cur_sig >= 51 && cur_sig <= 100)
-	{
 		ret_sig = 100;
-	}
 	else if(cur_sig >= 41 && cur_sig <= 50)
-	{
 		ret_sig = 80 + ((cur_sig - 40)*2);
-	}
 	else if(cur_sig >= 31 && cur_sig <= 40)
-	{
 		ret_sig = 66 + (cur_sig - 30);
-	}
 	else if(cur_sig >= 21 && cur_sig <= 30)
-	{
 		ret_sig = 54 + (cur_sig - 20);
-	}
 	else if(cur_sig >= 10 && cur_sig <= 20)
-	{
 		ret_sig = 42 + (((cur_sig - 10) * 2) / 3);
-	}
 	else if(cur_sig >= 5 && cur_sig <= 9)
-	{
 		ret_sig = 22 + (((cur_sig - 5) * 3) / 2);
-	}
 	else if(cur_sig >= 1 && cur_sig <= 4)
-	{
 		ret_sig = 6 + (((cur_sig - 1) * 3) / 2);
-	}
 	else
-	{
 		ret_sig = cur_sig;
-	}
-#else
-	HAL_DATA_TYPE	*pHalData = GET_HAL_DATA(padapter);
-
-	if(pHalData->CustomerID == RT_CID_819x_Lenovo)
-	{
-		return cur_sig;
-	}
-
-	// Step 1. Scale mapping.
-	if(cur_sig >= 61 && cur_sig <= 100)
-	{
-		ret_sig = 90 + ((cur_sig - 60) / 4);
-	}
-	else if(cur_sig >= 41 && cur_sig <= 60)
-	{
-		ret_sig = 78 + ((cur_sig - 40) / 2);
-	}
-	else if(cur_sig >= 31 && cur_sig <= 40)
-	{
-		ret_sig = 66 + (cur_sig - 30);
-	}
-	else if(cur_sig >= 21 && cur_sig <= 30)
-	{
-		ret_sig = 54 + (cur_sig - 20);
-	}
-	else if(cur_sig >= 5 && cur_sig <= 20)
-	{
-		ret_sig = 42 + (((cur_sig - 5) * 2) / 3);
-	}
-	else if(cur_sig == 4)
-	{
-		ret_sig = 36;
-	}
-	else if(cur_sig == 3)
-	{
-		ret_sig = 27;
-	}
-	else if(cur_sig == 2)
-	{
-		ret_sig = 18;
-	}
-	else if(cur_sig == 1)
-	{
-		ret_sig = 9;
-	}
-	else
-	{
-		ret_sig = cur_sig;
-	}
-#endif
-
 	return ret_sig;
 }
 
-
 static s32  translate2dbm(u8 signal_strength_idx)
 {
 	s32	signal_power; // in dBm.
