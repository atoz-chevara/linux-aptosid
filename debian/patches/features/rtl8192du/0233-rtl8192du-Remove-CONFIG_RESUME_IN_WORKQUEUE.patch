From 4a803caa521a084a24038dae605004043e3d477b Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Thu, 20 Feb 2014 14:20:11 -0600
Subject: [PATCH 233/390] rtl8192du: Remove CONFIG_RESUME_IN_WORKQUEUE

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 core/rtw_pwrctrl.c    | 39 ---------------------------------------
 include/drv_conf.h    |  7 -------
 include/rtw_pwrctrl.h |  8 --------
 os_dep/usb_intf.c     | 18 ++++--------------
 4 files changed, 4 insertions(+), 68 deletions(-)

--- a/drivers/staging/rtl8192du/core/rtw_pwrctrl.c
+++ b/drivers/staging/rtl8192du/core/rtw_pwrctrl.c
@@ -551,10 +551,6 @@ void LeaveAllPowerSaveMode(struct rtw_ad
 
 }
 
-#ifdef CONFIG_RESUME_IN_WORKQUEUE
-static void resume_workitem_callback(struct work_struct *work);
-#endif /* CONFIG_RESUME_IN_WORKQUEUE */
-
 void rtw_init_pwrctrl_priv(struct rtw_adapter *padapter)
 {
 	struct pwrctrl_priv *pwrctrlpriv = &padapter->pwrctrlpriv;
@@ -597,50 +593,15 @@ void rtw_init_pwrctrl_priv(struct rtw_ad
 
 	_init_timer(&(pwrctrlpriv->pwr_state_check_timer), padapter->pnetdev,
 		    pwr_state_check_handler, (u8 *)padapter);
-
-#ifdef CONFIG_RESUME_IN_WORKQUEUE
-	_init_workitem(&pwrctrlpriv->resume_work, resume_workitem_callback,
-		       NULL);
-	pwrctrlpriv->rtw_workqueue =
-	    create_singlethread_workqueue("rtw_workqueue");
-#endif /* CONFIG_RESUME_IN_WORKQUEUE */
 }
 
 void rtw_free_pwrctrl_priv(struct rtw_adapter *adapter)
 {
 	struct pwrctrl_priv *pwrctrlpriv = &adapter->pwrctrlpriv;
 
-#ifdef CONFIG_RESUME_IN_WORKQUEUE
-	if (pwrctrlpriv->rtw_workqueue) {
-		flush_workqueue(pwrctrlpriv->rtw_workqueue);
-		destroy_workqueue(pwrctrlpriv->rtw_workqueue);
-	}
-#endif
 	_free_pwrlock(&pwrctrlpriv->lock);
 }
 
-#ifdef CONFIG_RESUME_IN_WORKQUEUE
-extern int rtw_resume_process(struct rtw_adapter *padapter);
-static void resume_workitem_callback(struct work_struct *work)
-{
-	struct pwrctrl_priv *pwrpriv =
-	    container_of(work, struct pwrctrl_priv, resume_work);
-	struct rtw_adapter *adapter =
-	    container_of(pwrpriv, _adapter, pwrctrlpriv);
-
-	DBG_8192D("%s\n", __func__);
-	rtw_resume_process(adapter);
-}
-
-void rtw_resume_in_workqueue(struct pwrctrl_priv *pwrpriv)
-{
-	/*  accquire system's suspend lock preventing from falliing
-	 * asleep while resume in workqueue */
-	rtw_lock_suspend();
-	queue_work(pwrpriv->rtw_workqueue, &pwrpriv->resume_work);
-}
-#endif /* CONFIG_RESUME_IN_WORKQUEUE */
-
 u8 rtw_interface_ps_func(struct rtw_adapter *padapter,
 			 enum HAL_INTF_PS_FUNC efunc_id, u8 *val)
 {
--- a/drivers/staging/rtl8192du/include/drv_conf.h
+++ b/drivers/staging/rtl8192du/include/drv_conf.h
@@ -28,11 +28,4 @@
 #define CONFIG_SIGNAL_DISPLAY_DBM
 #endif
 
-#ifdef CONFIG_RESUME_IN_WORKQUEUE /* this can be removed, because there is no case for this... */
-	#if !defined(CONFIG_WAKELOCK)
-	#error "enable CONFIG_RESUME_IN_WORKQUEUE without CONFIG_WAKELOCK will suffer from the danger of wifi's unfunctionality..."
-	#error "If you still want to enable CONFIG_RESUME_IN_WORKQUEUE in this case, mask this preprossor checking and GOOD LUCK..."
-	#endif
-#endif
-
 #endif /*  __DRV_CONF_H__ */
--- a/drivers/staging/rtl8192du/include/rtw_pwrctrl.h
+++ b/drivers/staging/rtl8192du/include/rtw_pwrctrl.h
@@ -233,10 +233,6 @@ struct pwrctrl_priv
 	u8		brfoffbyhw;
 	unsigned long PS_BBRegBackup[PSBBREG_TOTALCNT];
 
-	#ifdef CONFIG_RESUME_IN_WORKQUEUE
-	struct workqueue_struct *rtw_workqueue;
-	struct work_struct resume_work;
-	#endif
 };
 
 #define rtw_get_ips_mode_req(pwrctrlpriv) \
@@ -277,10 +273,6 @@ rt_rf_power_state RfOnOffDetect(IN	struc
 void rtw_lps_enter(struct rtw_adapter * padapter);
 void rtw_lps_leave(struct rtw_adapter * padapter);
 
-#ifdef CONFIG_RESUME_IN_WORKQUEUE
-void rtw_resume_in_workqueue(struct pwrctrl_priv *pwrpriv);
-#endif /* CONFIG_RESUME_IN_WORKQUEUE */
-
 u8 rtw_interface_ps_func(struct rtw_adapter *padapter, enum HAL_INTF_PS_FUNC efunc_id,u8* val);
 void rtw_set_ips_deny(struct rtw_adapter *padapter, u32 ms);
 int _rtw_pwr_wakeup(struct rtw_adapter *padapter, u32 ips_deffer_ms, const char *caller);
--- a/drivers/staging/rtl8192du/os_dep/usb_intf.c
+++ b/drivers/staging/rtl8192du/os_dep/usb_intf.c
@@ -729,15 +729,10 @@ static int rtw_resume(struct usb_interfa
 	struct pwrctrl_priv *pwrpriv = &padapter->pwrctrlpriv;
 	 int ret = 0;
 
-	if (pwrpriv->bInternalAutoSuspend) {
+	if (pwrpriv->bInternalAutoSuspend)
 		ret = rtw_resume_process(padapter);
-	} else {
-#ifdef CONFIG_RESUME_IN_WORKQUEUE
-		rtw_resume_in_workqueue(pwrpriv);
-#else
+	else
 		ret = rtw_resume_process(padapter);
-#endif /* CONFIG_RESUME_IN_WORKQUEUE */
-	}
 
 	return ret;
 }
@@ -818,15 +813,10 @@ int rtw_resume_process(struct rtw_adapte
 
 	ret = 0;
 exit:
-	#ifdef CONFIG_RESUME_IN_WORKQUEUE
-	rtw_unlock_suspend();
-	#endif /* CONFIG_RESUME_IN_WORKQUEUE */
-
 	if (pwrpriv)
 		pwrpriv->bInSuspend = false;
-	DBG_8192D("<===  %s return %d.............. in %dms\n", __func__
-		, ret, rtw_get_passing_time_ms(start_time));
-
+	DBG_8192D("<===  %s return %d.............. in %dms\n", __func__,
+		  ret, rtw_get_passing_time_ms(start_time));
 	return ret;
 }
 
