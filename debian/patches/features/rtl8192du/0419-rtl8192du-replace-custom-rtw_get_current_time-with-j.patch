From b9018c04f9473d68a72e4ec98617de70df05470d Mon Sep 17 00:00:00 2001
From: Stefan Lippers-Hollmann <s.l-h@gmx.de>
Date: Sat, 22 Mar 2014 03:03:17 +0100
Subject: [PATCH 419/456] rtl8192du: replace custom rtw_get_current_time() with
 jiffies

Signed-off-by: Stefan Lippers-Hollmann <s.l-h@gmx.de>
---
 core/rtw_cmd.c          |  6 +++---
 core/rtw_ioctl_set.c    |  4 ++--
 core/rtw_mlme.c         | 14 +++++++-------
 core/rtw_mlme_ext.c     | 12 ++++++------
 core/rtw_p2p.c          |  2 +-
 core/rtw_pwrctrl.c      | 18 +++++++++---------
 core/rtw_xmit.c         |  4 ++--
 hal/rtl8192d_hal_init.c |  2 +-
 hal/usb_halinit.c       |  4 ++--
 include/osdep_service.h |  1 -
 os_dep/ioctl_cfg80211.c |  2 +-
 os_dep/os_intfs.c       |  4 ++--
 os_dep/osdep_service.c  |  5 -----
 os_dep/recv_linux.c     |  6 +++---
 os_dep/usb_intf.c       |  4 ++--
 15 files changed, 41 insertions(+), 47 deletions(-)

--- a/drivers/staging/rtl8192du/core/rtw_cmd.c
+++ b/drivers/staging/rtl8192du/core/rtw_cmd.c
@@ -457,7 +457,7 @@ u8 rtw_sitesurvey_cmd(struct rtw_adapter
 	res = rtw_enqueue_cmd(pcmdpriv, ph2c);
 
 	if (res == _SUCCESS) {
-		pmlmepriv->scan_start_time = rtw_get_current_time();
+		pmlmepriv->scan_start_time = jiffies;
 
 		_set_timer(&pmlmepriv->scan_to_timer, SCANNING_TIMEOUT);
 
@@ -1615,7 +1615,7 @@ static void lps_ctrl_wk_hdl(struct rtw_a
 				  (u8 *)(&mstatus));
 		break;
 	case LPS_CTRL_SPECIAL_PACKET:
-		pwrpriv->DelayLPSLastTimeStamp = rtw_get_current_time();
+		pwrpriv->DelayLPSLastTimeStamp = jiffies;
 		rtw_lps_leave(padapter);
 		break;
 
@@ -2014,7 +2014,7 @@ void rtw_createbss_cmd_callback(struct r
 				spin_unlock_bh(&(pmlmepriv->scanned_queue.lock));
 				goto createbss_cmd_fail;
 			}
-			pwlan->last_scanned = rtw_get_current_time();
+			pwlan->last_scanned = jiffies;
 		} else {
 			rtw_list_insert_tail(&(pwlan->list),
 					     &pmlmepriv->scanned_queue.queue);
--- a/drivers/staging/rtl8192du/core/rtw_ioctl_set.c
+++ b/drivers/staging/rtl8192du/core/rtw_ioctl_set.c
@@ -212,7 +212,7 @@ handle_tkip_countermeasure:
 	/* should we add something here...? */
 
 	if (padapter->securitypriv.btkip_countermeasure == true) {
-		cur_time = rtw_get_current_time();
+		cur_time = jiffies;
 
 		if ((cur_time - padapter->securitypriv.btkip_countermeasure_time) > 60 * HZ) {
 			padapter->securitypriv.btkip_countermeasure = false;
@@ -320,7 +320,7 @@ u8 rtw_set_802_11_ssid(struct rtw_adapte
 handle_tkip_countermeasure:
 
 	if (padapter->securitypriv.btkip_countermeasure == true) {
-		cur_time = rtw_get_current_time();
+		cur_time = jiffies;
 
 		if ((cur_time - padapter->securitypriv.btkip_countermeasure_time) > 60 * HZ) {
 			padapter->securitypriv.btkip_countermeasure = false;
--- a/drivers/staging/rtl8192du/core/rtw_mlme.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme.c
@@ -201,7 +201,7 @@ struct wlan_network *_rtw_alloc_network(
 		 ("_rtw_alloc_network: ptr=%p\n", plist));
 	pnetwork->network_type = 0;
 	pnetwork->fixed = false;
-	pnetwork->last_scanned = rtw_get_current_time();
+	pnetwork->last_scanned = jiffies;
 	pnetwork->aid = 0;
 	pnetwork->join_res = 0;
 
@@ -226,7 +226,7 @@ void _rtw_free_network(struct mlme_priv
 	if (pnetwork->fixed == true)
 		return;
 
-	curr_time = rtw_get_current_time();
+	curr_time = jiffies;
 
 	if ((check_fwstate(pmlmepriv, WIFI_ADHOC_MASTER_STATE) == true) ||
 	    (check_fwstate(pmlmepriv, WIFI_ADHOC_STATE) == true))
@@ -353,7 +353,7 @@ int rtw_if_up(struct rtw_adapter *padapt
 
 void rtw_generate_random_ibss(u8 *pibss)
 {
-	u32 curtime = rtw_get_current_time();
+	u32 curtime = jiffies;
 
 	pibss[0] = 0x02;	/* in ad-hoc mode bit1 must set to 1 */
 	pibss[1] = 0x11;
@@ -676,7 +676,7 @@ void rtw_update_scanned_network(struct r
 			       get_wlan_bssid_ex_sz(target));
 			/*  variable initialize */
 			pnetwork->fixed = false;
-			pnetwork->last_scanned = rtw_get_current_time();
+			pnetwork->last_scanned = jiffies;
 
 			pnetwork->network_type = 0;
 			pnetwork->aid = 0;
@@ -700,7 +700,7 @@ void rtw_update_scanned_network(struct r
 			target->Length = bssid_ex_sz;
 			memcpy(&(pnetwork->network), target, bssid_ex_sz);
 
-			pnetwork->last_scanned = rtw_get_current_time();
+			pnetwork->last_scanned = jiffies;
 
 			/* bss info not receving from the right channel */
 			if (pnetwork->network.PhyInfo.SignalQuality == 101)
@@ -716,7 +716,7 @@ void rtw_update_scanned_network(struct r
 		 */
 		bool update_ie = true;
 
-		pnetwork->last_scanned = rtw_get_current_time();
+		pnetwork->last_scanned = jiffies;
 
 		/* target.Reserved[0]==1, means that scaned network is a bcn frame. */
 		if ((pnetwork->network.IELength > target->IELength) &&
@@ -1163,7 +1163,7 @@ void rtw_scan_abort(struct rtw_adapter *
 	struct mlme_priv *pmlmepriv = &(adapter->mlmepriv);
 	struct mlme_ext_priv *pmlmeext = &(adapter->mlmeextpriv);
 
-	start = rtw_get_current_time();
+	start = jiffies;
 	pmlmeext->scan_abort = true;
 	while (check_fwstate(pmlmepriv, _FW_UNDER_SURVEY) &&
 		rtw_systime_to_ms(jiffies - start) <= 200) {
--- a/drivers/staging/rtl8192du/core/rtw_mlme_ext.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme_ext.c
@@ -4663,7 +4663,7 @@ int issue_probereq_p2p_ex(struct rtw_ada
 {
 	int ret;
 	int i = 0;
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 
 	do {
 		ret =
@@ -6289,7 +6289,7 @@ int issue_probereq_ex(struct rtw_adapter
 {
 	int ret;
 	int i = 0;
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 
 	do {
 		ret =
@@ -7206,7 +7206,7 @@ int issue_nulldata(struct rtw_adapter *a
 {
 	int ret;
 	int i = 0;
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 	struct mlme_ext_priv *pmlmeext = &(adapt->mlmeextpriv);
 	struct mlme_ext_info *pmlmeinfo = &(pmlmeext->mlmext_info);
 
@@ -7339,7 +7339,7 @@ int issue_qos_nulldata(struct rtw_adapte
 {
 	int ret;
 	int i = 0;
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 	struct mlme_ext_priv *pmlmeext = &(adapt->mlmeextpriv);
 	struct mlme_ext_info *pmlmeinfo = &(pmlmeext->mlmext_info);
 
@@ -7469,7 +7469,7 @@ int issue_deauth_ex(struct rtw_adapter *
 {
 	int ret;
 	int i = 0;
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 
 	do {
 		ret =
@@ -7928,7 +7928,7 @@ unsigned int send_beacon(struct rtw_adap
 	int issue = 0;
 	int poll = 0;
 
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 
 	rtw_hal_set_hwreg(adapt, HW_VAR_BCN_VALID, NULL);
 	do {
--- a/drivers/staging/rtl8192du/core/rtw_p2p.c
+++ b/drivers/staging/rtl8192du/core/rtw_p2p.c
@@ -2217,7 +2217,7 @@ void init_wifidirect_info(struct rtw_ada
 
 	rtw_p2p_findphase_ex_set(pwdinfo, P2P_FINDPHASE_EX_NONE);
 
-	pwdinfo->listen_dwell = (u8) ((rtw_get_current_time() % 3) + 1);
+	pwdinfo->listen_dwell = (u8) ((jiffies % 3) + 1);
 	/* DBG_8192D("[%s] listen_dwell time is %d00ms\n", __func__, pwdinfo->listen_dwell); */
 
 	memset(&pwdinfo->tx_prov_disc_info, 0x00, sizeof(struct tx_provdisc_req_info));
--- a/drivers/staging/rtl8192du/core/rtw_pwrctrl.c
+++ b/drivers/staging/rtl8192du/core/rtw_pwrctrl.c
@@ -112,7 +112,7 @@ static bool rtw_pwr_unassociated_idle(st
 
 	bool ret = false;
 
-	if (adapter->pwrctrlpriv.ips_deny_time >= rtw_get_current_time()) {
+	if (adapter->pwrctrlpriv.ips_deny_time >= jiffies) {
 		/* DBG_8192D("%s ips_deny_time\n", __func__); */
 		goto exit;
 	}
@@ -239,7 +239,7 @@ static u8 ps_rdy_check(struct rtw_adapte
 	struct pwrctrl_priv *pwrpriv = &padapter->pwrctrlpriv;
 	struct mlme_priv *pmlmepriv = &(padapter->mlmepriv);
 
-	curr_time = rtw_get_current_time();
+	curr_time = jiffies;
 
 	delta_time = curr_time - pwrpriv->DelayLPSLastTimeStamp;
 
@@ -391,7 +391,7 @@ void rtw_lps_leave(struct rtw_adapter *p
 			rtw_set_ps_mode(padapter, PS_MODE_ACTIVE, 0);
 
 			if (pwrpriv->pwr_mode == PS_MODE_ACTIVE) {
-				start_time = rtw_get_current_time();
+				start_time = jiffies;
 				while (1) {
 					rtw_hal_get_hwreg(padapter,
 							  HW_VAR_FWLPS_RF_ON,
@@ -478,7 +478,7 @@ u8 rtw_interface_ps_func(struct rtw_adap
 inline void rtw_set_ips_deny(struct rtw_adapter *padapter, u32 ms)
 {
 	struct pwrctrl_priv *pwrpriv = &padapter->pwrctrlpriv;
-	pwrpriv->ips_deny_time = rtw_get_current_time() + rtw_ms_to_systime(ms);
+	pwrpriv->ips_deny_time = jiffies + rtw_ms_to_systime(ms);
 }
 
 /*
@@ -493,7 +493,7 @@ int _rtw_pwr_wakeup(struct rtw_adapter *
 	struct pwrctrl_priv *pwrpriv = &padapter->pwrctrlpriv;
 	struct mlme_priv *pmlmepriv = &padapter->mlmepriv;
 	int ret = _SUCCESS;
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 
 #ifdef CONFIG_CONCURRENT_MODE
 	if (padapter->pbuddy_adapter)
@@ -507,9 +507,9 @@ int _rtw_pwr_wakeup(struct rtw_adapter *
 #endif
 
 	if (pwrpriv->ips_deny_time <
-	    rtw_get_current_time() + rtw_ms_to_systime(ips_deffer_ms))
+	    jiffies + rtw_ms_to_systime(ips_deffer_ms))
 		pwrpriv->ips_deny_time =
-		    rtw_get_current_time() + rtw_ms_to_systime(ips_deffer_ms);
+		    jiffies + rtw_ms_to_systime(ips_deffer_ms);
 
 	if (pwrpriv->ps_processing) {
 		DBG_8192D("%s wait ps_processing...\n", __func__);
@@ -576,9 +576,9 @@ int _rtw_pwr_wakeup(struct rtw_adapter *
 
 exit:
 	if (pwrpriv->ips_deny_time <
-	    rtw_get_current_time() + rtw_ms_to_systime(ips_deffer_ms))
+	    jiffies + rtw_ms_to_systime(ips_deffer_ms))
 		pwrpriv->ips_deny_time =
-		    rtw_get_current_time() + rtw_ms_to_systime(ips_deffer_ms);
+		    jiffies + rtw_ms_to_systime(ips_deffer_ms);
 	return ret;
 }
 
--- a/drivers/staging/rtl8192du/core/rtw_xmit.c
+++ b/drivers/staging/rtl8192du/core/rtw_xmit.c
@@ -2052,7 +2052,7 @@ void xmit_delivery_enabled_frames(struct
 void rtw_sctx_init(struct submit_ctx *sctx, int timeout_ms)
 {
 	sctx->timeout_ms = timeout_ms;
-	sctx->submit_time = rtw_get_current_time();
+	sctx->submit_time = jiffies;
 	init_completion(&sctx->done);
 	sctx->status = RTW_SCTX_SUBMITTED;
 }
@@ -2122,7 +2122,7 @@ static int rtw_ack_tx_polling(struct xmi
 	struct submit_ctx *pack_tx_ops = &pxmitpriv->ack_tx_ops;
 	struct rtw_adapter *adapter = container_of(pxmitpriv, struct rtw_adapter, xmitpriv);
 
-	pack_tx_ops->submit_time = rtw_get_current_time();
+	pack_tx_ops->submit_time = jiffies;
 	pack_tx_ops->timeout_ms = timeout_ms;
 	pack_tx_ops->status = RTW_SCTX_SUBMITTED;
 
--- a/drivers/staging/rtl8192du/hal/rtl8192d_hal_init.c
+++ b/drivers/staging/rtl8192du/hal/rtl8192d_hal_init.c
@@ -414,7 +414,7 @@ int FirmwareDownload92D(struct rtw_adapt
 		}
 
 		_FWDownloadEnable(adapter, true);
-		fwdl_start_time = rtw_get_current_time();
+		fwdl_start_time = jiffies;
 		while (1) {
 			/* reset the FWDL chksum */
 			rtw_write8(adapter, REG_MCUFWDL, rtw_read8(adapter, REG_MCUFWDL)|FWDL_ChkSum_rpt);
--- a/drivers/staging/rtl8192du/hal/usb_halinit.c
+++ b/drivers/staging/rtl8192du/hal/usb_halinit.c
@@ -1440,7 +1440,7 @@ static u32 rtl8192du_hal_init(struct rtw
 	u8	val8 = 0, tmpU1b;
 	u16	val16;
 	u32	boundary, i = 0,  status = _SUCCESS;
-	u32 init_start_time = rtw_get_current_time();
+	u32 init_start_time = jiffies;
 
 	padapter->init_adpt_in_progress = true;
 
@@ -2820,7 +2820,7 @@ _ReadRFType(
 
 static int _ReadadapterInfo8192DU(struct rtw_adapter *	adapter)
 {
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 
 	DBG_8192D("====> %s\n", __func__);
 
--- a/drivers/staging/rtl8192du/include/osdep_service.h
+++ b/drivers/staging/rtl8192du/include/osdep_service.h
@@ -195,7 +195,6 @@ void	_rtw_init_queue(struct __queue *pqu
 u32	_rtw_queue_empty(struct __queue *pqueue);
 u32	rtw_end_of_queue_search(struct list_head *queue, struct list_head *pelement);
 
-u32	rtw_get_current_time(void);
 u32	rtw_systime_to_ms(u32 systime);
 u32	rtw_ms_to_systime(u32 ms);
 
--- a/drivers/staging/rtl8192du/os_dep/ioctl_cfg80211.c
+++ b/drivers/staging/rtl8192du/os_dep/ioctl_cfg80211.c
@@ -3609,7 +3609,7 @@ static int cfg80211_rtw_mgmt_tx(struct w
 	u8 tx_ch = (u8)ieee80211_frequency_to_channel(chan->center_freq);
 	u8 category, action;
 	int type = (-1);
-	u32 start = rtw_get_current_time();
+	u32 start = jiffies;
 
 	/* cookie generation */
 	*cookie = (unsigned long) buf;
--- a/drivers/staging/rtl8192du/os_dep/os_intfs.c
+++ b/drivers/staging/rtl8192du/os_dep/os_intfs.c
@@ -1149,7 +1149,7 @@ netdev_open_error:
 int rtw_ips_pwr_up(struct rtw_adapter *padapter)
 {
 	int result;
-	u32 start_time = rtw_get_current_time();
+	u32 start_time = jiffies;
 	DBG_8192D("===>  rtw_ips_pwr_up..............\n");
 	rtw_reset_drv_sw(padapter);
 
@@ -1163,7 +1163,7 @@ int rtw_ips_pwr_up(struct rtw_adapter *p
 
 void rtw_ips_pwr_down(struct rtw_adapter *padapter)
 {
-	u32 start_time = rtw_get_current_time();
+	u32 start_time = jiffies;
 	DBG_8192D("===> rtw_ips_pwr_down...................\n");
 
 	padapter->bCardDisableWOHSM = true;
--- a/drivers/staging/rtl8192du/os_dep/osdep_service.c
+++ b/drivers/staging/rtl8192du/os_dep/osdep_service.c
@@ -152,11 +152,6 @@ u32 rtw_end_of_queue_search(struct list_
 		return false;
 }
 
-u32	rtw_get_current_time(void)
-{
-	return jiffies;
-}
-
 inline u32 rtw_systime_to_ms(u32 systime)
 {
 	return systime * 1000 / HZ;
--- a/drivers/staging/rtl8192du/os_dep/recv_linux.c
+++ b/drivers/staging/rtl8192du/os_dep/recv_linux.c
@@ -91,16 +91,16 @@ void rtw_handle_tkip_mic_err(struct rtw_
 	u32 cur_time = 0;
 
 	if (psecuritypriv->last_mic_err_time == 0) {
-		psecuritypriv->last_mic_err_time = rtw_get_current_time();
+		psecuritypriv->last_mic_err_time = jiffies;
 	} else {
-		cur_time = rtw_get_current_time();
+		cur_time = jiffies;
 
 		if (cur_time - psecuritypriv->last_mic_err_time < 60*HZ) {
 			psecuritypriv->btkip_countermeasure = true;
 			psecuritypriv->last_mic_err_time = 0;
 			psecuritypriv->btkip_countermeasure_time = cur_time;
 		} else {
-			psecuritypriv->last_mic_err_time = rtw_get_current_time();
+			psecuritypriv->last_mic_err_time = jiffies;
 		}
 	}
 
--- a/drivers/staging/rtl8192du/os_dep/usb_intf.c
+++ b/drivers/staging/rtl8192du/os_dep/usb_intf.c
@@ -378,7 +378,7 @@ static int rtw_suspend(struct usb_interf
 	struct wowlan_ioctl_param poidparam;
 #endif /*  CONFIG_WAKE_ON_WLAN */
 	int ret = 0;
-	u32 start_time = rtw_get_current_time();
+	u32 start_time = jiffies;
 
 	DBG_8192D("==> %s (%s:%d)\n",__func__, current->comm, current->pid);
 
@@ -451,7 +451,7 @@ int rtw_resume_process(struct rtw_adapte
 	struct net_device *pnetdev;
 	struct pwrctrl_priv *pwrpriv = NULL;
 	int ret = -1;
-	u32 start_time = rtw_get_current_time();
+	u32 start_time = jiffies;
 
 	DBG_8192D("==> %s (%s:%d)\n",__func__, current->comm, current->pid);
 
