From 231291322313c9b4f8c1445ead46bd516c3cb02d Mon Sep 17 00:00:00 2001
From: Stefan Lippers-Hollmann <s.l-h@gmx.de>
Date: Sat, 22 Mar 2014 03:02:56 +0100
Subject: [PATCH 398/456] rtl8192du: use module_usb_driver() and switch to
 modern module init

Signed-off-by: Stefan Lippers-Hollmann <s.l-h@gmx.de>
---
 os_dep/usb_intf.c | 45 +++++++++------------------------------------
 1 file changed, 9 insertions(+), 36 deletions(-)

--- a/drivers/staging/rtl8192du/os_dep/usb_intf.c
+++ b/drivers/staging/rtl8192du/os_dep/usb_intf.c
@@ -70,22 +70,16 @@ static struct specific_device_id specifi
 	{}
 };
 
-struct rtw_usb_drv {
-	struct usb_driver usbdrv;
-	int drv_registered;
+static struct usb_driver rtl8192d_usb_drv = {
+	.name		= "rtl8192du",
+	.probe		= rtw_drv_init,
+	.disconnect	= rtw_dev_remove,
+	.id_table	= rtl8192d_usb_id_tbl,
+	.suspend	= rtw_suspend,
+	.resume		= rtw_resume,
+	.reset_resume	= rtw_resume,
 };
 
-static struct rtw_usb_drv rtl8192d_usb_drv = {
-	.usbdrv.name = (char*)"rtl8192du",
-	.usbdrv.probe = rtw_drv_init,
-	.usbdrv.disconnect = rtw_dev_remove,
-	.usbdrv.id_table = rtl8192d_usb_id_tbl,
-	.usbdrv.suspend =  rtw_suspend,
-	.usbdrv.resume = rtw_resume,
-	.usbdrv.reset_resume   = rtw_resume,
-};
-static struct rtw_usb_drv *usb_drv = &rtl8192d_usb_drv;
-
 static inline int RT_usb_endpoint_dir_in(const struct usb_endpoint_descriptor *epd)
 {
 	return ((epd->bEndpointAddress & USB_ENDPOINT_DIR_MASK) == USB_DIR_IN);
@@ -758,9 +752,6 @@ static void rtw_dev_remove(struct usb_in
 
 	DBG_8192D("+rtw_dev_remove\n");
 
-	if (usb_drv->drv_registered )
-		padapter->bSurpriseRemoved = true;
-
 	rtw_pm_set_ips(padapter, IPS_NONE);
 	rtw_pm_set_lps(padapter, PS_MODE_ACTIVE);
 
@@ -784,22 +775,4 @@ static void rtw_dev_remove(struct usb_in
 	return;
 }
 
-static int __init rtw_drv_entry(void)
-{
-	usb_drv->drv_registered = true;
-	return usb_register(&usb_drv->usbdrv);
-}
-
-static void __exit rtw_drv_halt(void)
-{
-	RT_TRACE(_module_hci_intfs_c_,_drv_err_,("+rtw_drv_halt\n"));
-	DBG_8192D("+rtw_drv_halt\n");
-
-	usb_drv->drv_registered = false;
-	usb_deregister(&usb_drv->usbdrv);
-
-	DBG_8192D("-rtw_drv_halt\n");
-}
-
-module_init(rtw_drv_entry);
-module_exit(rtw_drv_halt);
+module_usb_driver(rtl8192d_usb_drv);
