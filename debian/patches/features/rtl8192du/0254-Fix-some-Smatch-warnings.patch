From dbad13ef2521feb81bcfb18727ec5be7a65b0cdd Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Fri, 14 Mar 2014 12:18:34 -0500
Subject: [PATCH 254/390] Fix some Smatch warnings

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 core/rtw_mlme.c         |   4 --
 core/rtw_xmit.c         |  16 ++-----
 hal/rtl8192d_hal_init.c |   2 +-
 os_dep/ioctl_cfg80211.c | 114 +++++++++++++++++-------------------------------
 os_dep/ioctl_linux.c    |  34 ++++++++-------
 5 files changed, 64 insertions(+), 106 deletions(-)

--- a/drivers/staging/rtl8192du/core/rtw_mlme.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme.c
@@ -2344,12 +2344,8 @@ int rtw_set_key(struct rtw_adapter *adap
 
 	INIT_LIST_HEAD(&pcmd->list);
 
-	/* _rtw_init_sema(&(pcmd->cmd_sem), 0); */
-
 	res = rtw_enqueue_cmd(pcmdpriv, pcmd);
-
 exit:
-
 	return res;
 }
 
--- a/drivers/staging/rtl8192du/core/rtw_xmit.c
+++ b/drivers/staging/rtl8192du/core/rtw_xmit.c
@@ -1657,18 +1657,10 @@ void rtw_alloc_hwxmits(struct rtw_adapte
 
 	hwxmits = pxmitpriv->hwxmits;
 
-	if (pxmitpriv->hwxmit_entry == 5) {
-		hwxmits[0] .sta_queue = &pxmitpriv->bm_pending;
-		hwxmits[1] .sta_queue = &pxmitpriv->vo_pending;
-		hwxmits[2] .sta_queue = &pxmitpriv->vi_pending;
-		hwxmits[3] .sta_queue = &pxmitpriv->bk_pending;
-		hwxmits[4] .sta_queue = &pxmitpriv->be_pending;
-	} else if (pxmitpriv->hwxmit_entry == 4) {
-		hwxmits[0] .sta_queue = &pxmitpriv->vo_pending;
-		hwxmits[1] .sta_queue = &pxmitpriv->vi_pending;
-		hwxmits[2] .sta_queue = &pxmitpriv->be_pending;
-		hwxmits[3] .sta_queue = &pxmitpriv->bk_pending;
-	}
+	hwxmits[0].sta_queue = &pxmitpriv->vo_pending;
+	hwxmits[1].sta_queue = &pxmitpriv->vi_pending;
+	hwxmits[2].sta_queue = &pxmitpriv->be_pending;
+	hwxmits[3].sta_queue = &pxmitpriv->bk_pending;
 }
 
 void rtw_free_hwxmits(struct rtw_adapter *padapter)
--- a/drivers/staging/rtl8192du/hal/rtl8192d_hal_init.c
+++ b/drivers/staging/rtl8192du/hal/rtl8192d_hal_init.c
@@ -342,7 +342,7 @@ int FirmwareDownload92D(struct rtw_adapt
 	if (adapter->bSurpriseRemoved)
 		return _FAIL;
 
-	if (!adapter->firmware) {
+	if (!adapter->firmware || !adapter->firmware->buffer) {
 		if (!get_fw_from_file(adapter)) {
 			rtStatus = _FAIL;
 			adapter->firmware = NULL;
--- a/drivers/staging/rtl8192du/os_dep/ioctl_cfg80211.c
+++ b/drivers/staging/rtl8192du/os_dep/ioctl_cfg80211.c
@@ -556,20 +556,18 @@ static int set_group_key(struct rtw_adap
 
 	psetkeyparm->set_tx = 1;
 
-	switch (alg)
-	{
-		case _WEP40_:
-			keylen = 5;
-			break;
-		case _WEP104_:
-			keylen = 13;
-			break;
-		case _TKIP_:
-		case _TKIP_WTMIC_:
-		case _AES_:
-			keylen = 16;
-		default:
-			keylen = 16;
+	switch (alg) {
+	case _WEP40_:
+		keylen = 5;
+		break;
+	case _WEP104_:
+		keylen = 13;
+		break;
+	case _TKIP_:
+	case _TKIP_WTMIC_:
+	case _AES_:
+	default:
+		keylen = 16;
 	}
 
 	memcpy(&(psetkeyparm->key[0]), key, keylen);
@@ -1538,36 +1536,31 @@ static int rtw_cfg80211_set_probe_req_wp
 static int cfg80211_rtw_scan(struct wiphy *wiphy,
 			     struct cfg80211_scan_request *request)
 {
-	int i;
-	u8 _status = false;
-	int ret = 0;
 	struct rtw_adapter *padapter = wiphy_to_adapter(wiphy);
 	struct mlme_priv *pmlmepriv= &padapter->mlmepriv;
 	struct ndis_802_11_ssid ssid[RTW_SSID_SCAN_AMOUNT];
 	struct rtw_ieee80211_channel ch[RTW_CHANNEL_SCAN_AMOUNT];
-	u8 *wps_ie=NULL;
-	uint wps_ielen=0;
-	u8 *p2p_ie=NULL;
-	uint p2p_ielen=0;
 #ifdef CONFIG_P2P
 	struct wifidirect_info *pwdinfo= &(padapter->wdinfo);
 #endif /* CONFIG_P2P */
 	struct rtw_wdev_priv *pwdev_priv = wdev_to_priv(padapter->rtw_wdev);
 	struct cfg80211_ssid *ssids = request->ssids;
-	int social_channel = 0, j = 0;
-	bool need_indicate_scan_done = false;
 #ifdef CONFIG_CONCURRENT_MODE
 	struct rtw_adapter *pbuddy_adapter = NULL;
 	struct mlme_priv *pbuddy_mlmepriv = NULL;
 #endif /* CONFIG_CONCURRENT_MODE */
-
-#ifdef CONFIG_DEBUG_CFG80211
-	DBG_8192D(FUNC_ADPT_FMT"\n", FUNC_ADPT_ARG(padapter));
-#endif
+	int i;
+	u8 _status = false;
+	int ret = 0;
+	u8 *wps_ie=NULL;
+	uint wps_ielen=0;
+	u8 *p2p_ie=NULL;
+	uint p2p_ielen=0;
+	int social_channel = 0, j = 0;
+	bool need_indicate_scan_done = false;
 
 #ifdef CONFIG_CONCURRENT_MODE
-	if (rtw_buddy_adapter_up(padapter))
-	{
+	if (rtw_buddy_adapter_up(padapter)) {
 		pbuddy_adapter = padapter->pbuddy_adapter;
 		pbuddy_mlmepriv = &(pbuddy_adapter->mlmepriv);
 	}
@@ -1577,14 +1570,6 @@ static int cfg80211_rtw_scan(struct wiph
 	pwdev_priv->scan_request = request;
 	spin_unlock_bh(&pwdev_priv->scan_req_lock);
 
-	if (check_fwstate(pmlmepriv, WIFI_AP_STATE) == true)
-	{
-
-#ifdef CONFIG_DEBUG_CFG80211
-		DBG_8192D("%s under WIFI_AP_STATE\n", __func__);
-#endif
-	}
-
 	if (_FAIL == rtw_pwr_wakeup(padapter)) {
 		need_indicate_scan_done = true;
 		goto check_need_indicate_scan_done;
@@ -2129,14 +2114,13 @@ static int cfg80211_rtw_connect(struct w
 	phead = get_list_head(queue);
 	pmlmepriv->pscanned = phead->next;
 
-	while (1)
-	{
-		if (rtw_end_of_queue_search(phead, pmlmepriv->pscanned) == true)
-		{
+	while (1) {
+		if (rtw_end_of_queue_search(phead, pmlmepriv->pscanned))
 			break;
-		}
 
 		pnetwork = container_of(pmlmepriv->pscanned, struct wlan_network, list);
+		if (!pnetwork)
+			break;
 		pmlmepriv->pscanned = pmlmepriv->pscanned->next;
 
 		dst_ssid = pnetwork->network.Ssid.Ssid;
@@ -2148,14 +2132,12 @@ static int cfg80211_rtw_connect(struct w
 		}
 
 		if (sme->ssid && sme->ssid_len) {
-			if (	pnetwork->network.Ssid.SsidLength != sme->ssid_len
-				|| _rtw_memcmp(pnetwork->network.Ssid.Ssid, (void *)sme->ssid, sme->ssid_len) == false
-			)
+			if (pnetwork->network.Ssid.SsidLength != sme->ssid_len ||
+			    !_rtw_memcmp(pnetwork->network.Ssid.Ssid, (void *)sme->ssid, sme->ssid_len))
 				continue;
 		}
 
-		if (sme->bssid)
-		{
+		if (sme->bssid) {
 			src_bssid = sme->bssid;
 
 			if (_rtw_memcmp(dst_bssid, (void *)src_bssid, ETH_ALEN)) {
@@ -2168,24 +2150,19 @@ static int cfg80211_rtw_connect(struct w
 				break;
 			}
 
-		}
-		else if (sme->ssid && sme->ssid_len)
-		{
+		} else if (sme->ssid && sme->ssid_len) {
 			src_ssid = ndis_ssid.Ssid;
 
 			if ((_rtw_memcmp(dst_ssid, src_ssid, ndis_ssid.SsidLength) == true) &&
-				(pnetwork->network.Ssid.SsidLength==ndis_ssid.SsidLength))
-			{
+			    (pnetwork->network.Ssid.SsidLength == ndis_ssid.SsidLength)) {
 				DBG_8192D("matched by ssid\n");
-				matched=true;
+				matched = true;
 				break;
 			}
 		}
-
 	}
 
-	if ((matched == false) || (pnetwork== NULL))
-	{
+	if (!matched || !pnetwork) {
 		ret = -ENOENT;
 		DBG_8192D("connect, matched == false, goto exit\n");
 		spin_unlock_bh(&queue->lock);
@@ -2193,8 +2170,7 @@ static int cfg80211_rtw_connect(struct w
 		goto exit;
 	}
 
-	if (rtw_set_802_11_infrastructure_mode(padapter, pnetwork->network.InfrastructureMode) == false)
-	{
+	if (!rtw_set_802_11_infrastructure_mode(padapter, pnetwork->network.InfrastructureMode)) {
 		ret = -EPERM;
 		spin_unlock_bh(&queue->lock);
 		spin_unlock_bh(&pmlmepriv->lock);
@@ -2230,10 +2206,8 @@ static int cfg80211_rtw_connect(struct w
 	}
 
 	/* For WEP Shared auth */
-	if ((psecuritypriv->dot11AuthAlgrthm == dot11AuthAlgrthm_Shared
-		|| psecuritypriv->dot11AuthAlgrthm == dot11AuthAlgrthm_Auto) && sme->key
-	)
-	{
+	if ((psecuritypriv->dot11AuthAlgrthm == dot11AuthAlgrthm_Shared ||
+	    psecuritypriv->dot11AuthAlgrthm == dot11AuthAlgrthm_Auto) && sme->key) {
 		u32 wep_key_idx, wep_key_len,wep_total_len;
 		struct ndis_802_11_wep *pwep = NULL;
 		DBG_8192D("%s(): Shared/Auto WEP\n",__func__);
@@ -2246,13 +2220,12 @@ static int cfg80211_rtw_connect(struct w
 			goto exit;
 		}
 
-		if (wep_key_len > 0)
-		{
+		if (wep_key_len > 0) {
 			wep_key_len = wep_key_len <= 5 ? 5 : 13;
 			wep_total_len = wep_key_len + FIELD_OFFSET(struct ndis_802_11_wep, KeyMaterial);
 			pwep =(struct ndis_802_11_wep *) kmalloc(wep_total_len, GFP_KERNEL);
 			if (pwep == NULL) {
-				DBG_8192D(" wpa_set_encryption: pwep allocate fail !!!\n");
+				DBG_8192D("wpa_set_encryption: pwep allocate fail!!!\n");
 				ret = -ENOMEM;
 				goto exit;
 			}
@@ -2262,13 +2235,11 @@ static int cfg80211_rtw_connect(struct w
 			pwep->KeyLength = wep_key_len;
 			pwep->Length = wep_total_len;
 
-			if (wep_key_len==13)
-			{
+			if (wep_key_len == 13) {
 				padapter->securitypriv.dot11PrivacyAlgrthm=_WEP104_;
 				padapter->securitypriv.dot118021XGrpPrivacy=_WEP104_;
 			}
-		}
-		else {
+		} else {
 			ret = -EINVAL;
 			goto exit;
 		}
@@ -2311,7 +2282,6 @@ static int cfg80211_rtw_connect(struct w
 exit:
 
 	DBG_8192D("<=%s, ret %d\n",__func__, ret);
-
 	return ret;
 }
 
@@ -2324,8 +2294,7 @@ static int cfg80211_rtw_disconnect(struc
 
 	rtw_set_roaming(padapter, 0);
 
-	if (check_fwstate(&padapter->mlmepriv, _FW_LINKED))
-	{
+	if (check_fwstate(&padapter->mlmepriv, _FW_LINKED)) {
 		rtw_scan_abort(padapter);
 		LeaveAllPowerSaveMode(padapter);
 		rtw_disassoc_cmd(padapter, 500, false);
@@ -2338,7 +2307,6 @@ static int cfg80211_rtw_disconnect(struc
 
 		rtw_free_assoc_resources(padapter, 1);
 	}
-
 	return 0;
 }
 
--- a/drivers/staging/rtl8192du/os_dep/ioctl_linux.c
+++ b/drivers/staging/rtl8192du/os_dep/ioctl_linux.c
@@ -3047,11 +3047,11 @@ static int rtw_wps_start(struct net_devi
 	u32   u32wps_start = 0;
 	unsigned int uintRet = 0;
 
+	if (!pdata || padapter->bDriverStopped)
+		return -EINVAL;
 	uintRet = copy_from_user((void*) &u32wps_start, pdata->pointer, 4);
-	if (uintRet || padapter->bDriverStopped || pdata == NULL) {
-		ret = -EINVAL;
-		goto exit;
-	}
+	if (uintRet)
+		return -EINVAL;
 
 	if (u32wps_start == 0)
 		u32wps_start = *extra;
@@ -5090,30 +5090,32 @@ static int rtw_dbg_port(struct net_devic
 			case 0x12: /* set rx_stbc */
 			{
 				struct registry_priv	*pregpriv = &padapter->registrypriv;
-				/*  0: disable, bit(0):enable 2.4g, bit(1):enable 5g, 0x3: enable both 2.4g and 5g */
-				/* default is set to enable 2.4GHZ for IOT issue with bufflao's AP at 5GHZ */
-				if (pregpriv && (extra_arg == 0 || extra_arg == 1|| extra_arg == 2 || extra_arg == 3))
-				{
+				/*  0: disable, bit(0):enable 2.4g, bit(1):enable 5g,
+				 * 0x3: enable both 2.4g and 5g
+				 * default is set to enable 2.4GHZ for IOT issue with
+				 * Buffalo's AP at 5GHZ
+				 */
+				if (pregpriv && (extra_arg >= 0 && extra_arg <= 3)) {
 					pregpriv->rx_stbc = extra_arg;
 					DBG_8192D("set rx_stbc =%d\n", pregpriv->rx_stbc);
-				}
-				else
+				} else {
 					DBG_8192D("get rx_stbc =%d\n", pregpriv->rx_stbc);
+				}
 
 			}
 			break;
 			case 0x13: /* set ampdu_enable */
 			{
 				struct registry_priv	*pregpriv = &padapter->registrypriv;
-				/*  0: disable, 0x1:enable (but wifi_spec should be 0), 0x2: force enable (don't care wifi_spec) */
-				if (pregpriv && extra_arg >= 0 && extra_arg < 3)
-				{
+				/*  0: disable, 0x1:enable (but wifi_spec should be 0),
+				 *  0x2: force enable (don't care wifi_spec)
+				 */
+				if (pregpriv && (extra_arg >= 0 && extra_arg < 3)) {
 					pregpriv->ampdu_enable = extra_arg;
 					DBG_8192D("set ampdu_enable =%d\n", pregpriv->ampdu_enable);
-				}
-				else
+				} else {
 					DBG_8192D("get ampdu_enable =%d\n", pregpriv->ampdu_enable);
-
+				}
 			}
 			break;
 			case 0x14: /* get wifi_spec */
