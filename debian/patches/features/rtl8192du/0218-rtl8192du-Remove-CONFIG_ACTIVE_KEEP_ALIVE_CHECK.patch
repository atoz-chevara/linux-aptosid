From c7fecef48bcbd0455f2971a68b371dd68640ad81 Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Wed, 19 Feb 2014 22:00:12 -0600
Subject: [PATCH 218/390] rtl8192du: Remove CONFIG_ACTIVE_KEEP_ALIVE_CHECK

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 core/rtw_ap.c       | 24 ------------------------
 core/rtw_cmd.c      |  2 --
 core/rtw_mlme.c     |  7 -------
 core/rtw_mlme_ext.c | 15 +--------------
 core/rtw_sta_mgt.c  |  4 ----
 include/autoconf.h  |  2 --
 6 files changed, 1 insertion(+), 53 deletions(-)

--- a/drivers/staging/rtl8192du/core/rtw_ap.c
+++ b/drivers/staging/rtl8192du/core/rtw_ap.c
@@ -336,28 +336,7 @@ void	expire_timeout_chk(struct rtw_adapt
 			psta->expire_to--;
 		}
 
-#ifndef CONFIG_ACTIVE_KEEP_ALIVE_CHECK
-		if ((psta->flags & WLAN_STA_HT) && (psta->htpriv.agg_enable_bitmap || psta->under_exist_checking)) {
-			/*  check sta by delba(addba) for 11n STA */
-			/*  ToDo: use CCX report to check for all STAs */
-
-			if (psta->expire_to <= (pstapriv->expire_to - 50)) {
-				DBG_8192D("asoc expire by DELBA/ADDBA! (%d s)\n", (pstapriv->expire_to-psta->expire_to)*2);
-				psta->under_exist_checking = 0;
-				psta->expire_to = 0;
-			} else if (psta->expire_to <= (pstapriv->expire_to - 3) && (psta->under_exist_checking == 0)) {
-				DBG_8192D("asoc check by DELBA/ADDBA! (%d s)\n", (pstapriv->expire_to-psta->expire_to)*2);
-				psta->under_exist_checking = 1;
-				/* tear down TX AMPDU */
-				send_delba(padapter, 1, psta->hwaddr);/* originator */
-				psta->htpriv.agg_enable_bitmap = 0x0;/* reset */
-				psta->htpriv.candidate_tid_bitmap = 0x0;/* reset */
-			}
-		}
-#endif /* CONFIG_ACTIVE_KEEP_ALIVE_CHECK */
-
 		if (psta->expire_to <= 0) {
-			#ifdef CONFIG_ACTIVE_KEEP_ALIVE_CHECK
 			struct mlme_ext_priv *pmlmeext = &padapter->mlmeextpriv;
 
 			if (padapter->registrypriv.wifi_spec == 1) {
@@ -389,7 +368,6 @@ void	expire_timeout_chk(struct rtw_adapt
 
 				continue;
 			}
-			#endif /* CONFIG_ACTIVE_KEEP_ALIVE_CHECK */
 
 			list_del_init(&psta->asoc_list);
 			pstapriv->asoc_list_cnt--;
@@ -411,7 +389,6 @@ void	expire_timeout_chk(struct rtw_adapt
 
 	spin_unlock_bh(&pstapriv->asoc_list_lock);
 
-#ifdef CONFIG_ACTIVE_KEEP_ALIVE_CHECK
 	if (chk_alive_num) {
 		u8 backup_oper_channel = 0;
 		struct mlme_ext_priv *pmlmeext = &padapter->mlmeextpriv;
@@ -458,7 +435,6 @@ void	expire_timeout_chk(struct rtw_adapt
 		if (backup_oper_channel > 0) /* back to the original operation channel */
 			SelectChannel(padapter, backup_oper_channel);
 	}
-#endif /* CONFIG_ACTIVE_KEEP_ALIVE_CHECK */
 
 	associated_clients_update(padapter, updated);
 }
--- a/drivers/staging/rtl8192du/core/rtw_cmd.c
+++ b/drivers/staging/rtl8192du/core/rtw_cmd.c
@@ -1740,12 +1740,10 @@ static void dynamic_chk_wk_hdl(struct rt
 
 	pmlmepriv = &(padapter->mlmepriv);
 
-#ifdef CONFIG_ACTIVE_KEEP_ALIVE_CHECK
 #ifdef CONFIG_92D_AP_MODE
 	if (check_fwstate(pmlmepriv, WIFI_AP_STATE) == true)
 		expire_timeout_chk(padapter);
 #endif
-#endif /* CONFIG_ACTIVE_KEEP_ALIVE_CHECK */
 
 	#ifdef DBG_CONFIG_ERROR_DETECT
 	rtw_hal_sreset_xmit_status_check(padapter);
--- a/drivers/staging/rtl8192du/core/rtw_mlme.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme.c
@@ -2163,13 +2163,6 @@ void rtw_dynamic_check_timer_handlder(st
 			rtw_auto_scan_handler(adapter);
 		}
 	}
-#ifndef CONFIG_ACTIVE_KEEP_ALIVE_CHECK
-#ifdef CONFIG_92D_AP_MODE
-	if (check_fwstate(pmlmepriv, WIFI_AP_STATE) == true) {
-		expire_timeout_chk(adapter);
-	}
-#endif
-#endif /* CONFIG_ACTIVE_KEEP_ALIVE_CHECK */
 
 #ifdef CONFIG_BR_EXT
 
--- a/drivers/staging/rtl8192du/core/rtw_mlme_ext.c
+++ b/drivers/staging/rtl8192du/core/rtw_mlme_ext.c
@@ -532,10 +532,7 @@ int init_mlme_ext_priv(struct rtw_adapte
 	pmlmeext->chan_scan_time = SURVEY_TO;
 	pmlmeext->mlmeext_init = true;
 
-#ifdef CONFIG_ACTIVE_KEEP_ALIVE_CHECK
 	pmlmeext->active_keep_alive_check = true;
-#endif
-
 	return res;
 }
 
@@ -10278,13 +10275,7 @@ void linked_status_chk(struct rtw_adapte
 		int tx_chk = _SUCCESS, rx_chk = _SUCCESS;
 		int rx_chk_limit;
 
-#if defined(DBG_ROAMING_TEST)
-		rx_chk_limit = 1;
-#elif defined(CONFIG_ACTIVE_KEEP_ALIVE_CHECK)
 		rx_chk_limit = 4;
-#else
-		rx_chk_limit = 8;
-#endif
 
 #ifdef CONFIG_INTEL_WIDI
 		if (adapt->mlmepriv.widi_state != INTEL_WIDI_STATE_NONE)
@@ -10306,7 +10297,6 @@ void linked_status_chk(struct rtw_adapte
 			if (pxmitpriv->last_tx_pkts == pxmitpriv->tx_pkts)
 				tx_chk = _FAIL;
 
-#ifdef CONFIG_ACTIVE_KEEP_ALIVE_CHECK
 			if (pmlmeext->active_keep_alive_check &&
 			    (rx_chk == _FAIL || tx_chk == _FAIL)) {
 				u8 backup_oper_channel = 0;
@@ -10341,10 +10331,7 @@ void linked_status_chk(struct rtw_adapte
 				if (backup_oper_channel > 0)
 					SelectChannel(adapt,
 						      backup_oper_channel);
-
-			} else
-#endif /* CONFIG_ACTIVE_KEEP_ALIVE_CHECK */
-			{
+			} else {
 				if (rx_chk != _SUCCESS) {
 					if (pmlmeext->retry == 0) {
 						issue_probereq(adapt,
--- a/drivers/staging/rtl8192du/core/rtw_sta_mgt.c
+++ b/drivers/staging/rtl8192du/core/rtw_sta_mgt.c
@@ -116,11 +116,7 @@ u32	_rtw_init_sta_priv(struct	sta_priv *
 
 	pstapriv->auth_to = 3; /*  3*2 = 6 sec */
 	pstapriv->assoc_to = 3;
-#ifdef CONFIG_ACTIVE_KEEP_ALIVE_CHECK
 	pstapriv->expire_to = 3; /*  3*2 = 6 sec */
-#else
-	pstapriv->expire_to = 60;/*  60*2 = 120 sec = 2 min, expire after no any traffic. */
-#endif
 	pstapriv->max_num_sta = NUM_STA;
 
 #endif
--- a/drivers/staging/rtl8192du/include/autoconf.h
+++ b/drivers/staging/rtl8192du/include/autoconf.h
@@ -39,8 +39,6 @@
 #endif /* CONFIG_WAKE_ON_WLAN */
 #define CONFIG_R871X_TEST	1
 
-#define CONFIG_ACTIVE_KEEP_ALIVE_CHECK
-
 #define CONFIG_80211N_HT	1
 
 #define CONFIG_RECV_REORDERING_CTRL	1
