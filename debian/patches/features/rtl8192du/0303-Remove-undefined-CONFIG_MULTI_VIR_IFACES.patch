From 2ee1ce6719594723fa96435e1ccee9b7eb675adb Mon Sep 17 00:00:00 2001
From: Larry Finger <Larry.Finger@lwfinger.net>
Date: Sat, 15 Mar 2014 17:45:18 -0500
Subject: [PATCH 303/390] Remove undefined CONFIG_MULTI_VIR_IFACES

Signed-off-by: Larry Finger <Larry.Finger@lwfinger.net>
---
 include/drv_types.h  |   5 -
 include/osdep_intf.h |   6 -
 os_dep/os_intfs.c    | 348 +--------------------------------------------------
 os_dep/usb_intf.c    |  19 +--
 4 files changed, 2 insertions(+), 376 deletions(-)

--- a/drivers/staging/rtl8192du/include/drv_types.h
+++ b/drivers/staging/rtl8192du/include/drv_types.h
@@ -149,13 +149,8 @@ struct registry_priv {
 	u8 ifname[16];
 	u8 if2name[16];
 	u8 notch_filter;
-
-#ifdef CONFIG_MULTI_VIR_IFACES
-	u8 ext_iface_num;/* primary/secondary iface is excluded */
-#endif
 };
 
-
 /* For registry parameters */
 #define RGTRY_OFT(field) ((u32)FIELD_OFFSET(struct registry_priv, field))
 #define RGTRY_SZ(field)   sizeof(((struct registry_priv*) 0)->field)
--- a/drivers/staging/rtl8192du/include/osdep_intf.h
+++ b/drivers/staging/rtl8192du/include/osdep_intf.h
@@ -87,12 +87,6 @@ struct _io_ops;
 struct rtw_adapter *rtw_drv_if2_init(struct rtw_adapter *primary_padapter, char *name, void (*set_intf_ops)(struct _io_ops *pops));
 void rtw_drv_if2_free(struct rtw_adapter *if2);
 void rtw_drv_if2_stop(struct rtw_adapter *if2);
-#ifdef CONFIG_MULTI_VIR_IFACES
-struct dvobj_priv;
-_adapter *rtw_drv_add_vir_if (struct rtw_adapter *primary_padapter, char *name,	void (*set_intf_ops)(struct _io_ops *pops));
-void rtw_drv_stop_vir_ifaces(struct dvobj_priv *dvobj);
-void rtw_drv_free_vir_ifaces(struct dvobj_priv *dvobj);
-#endif /* CONFIG_MULTI_VIR_IFACES */
 #endif
 
 void rtw_ndev_destructor(struct net_device *ndev);
--- a/drivers/staging/rtl8192du/os_dep/os_intfs.c
+++ b/drivers/staging/rtl8192du/os_dep/os_intfs.c
@@ -25,6 +25,7 @@
 #include <rtw_ioctl.h>
 #include <usb_osintf.h>
 #include <rtl8192d_hal.h>
+#include <usb_hal.h>
 #include <linux/vmalloc.h>
 
 MODULE_LICENSE("GPL");
@@ -139,11 +140,6 @@ MODULE_PARM_DESC(if2name, "The default n
 
 char *rtw_initmac = NULL;  /*  temp mac address if users want to use instead of the mac address in Efuse */
 
-#ifdef CONFIG_MULTI_VIR_IFACES
-int rtw_ext_iface_num  = 1;/* primary/secondary iface is excluded */
-module_param(rtw_ext_iface_num, int, 0644);
-#endif /* CONFIG_MULTI_VIR_IFACES */
-
 module_param(rtw_initmac, charp, 0644);
 module_param(rtw_channel_plan, int, 0644);
 module_param(rtw_chip_version, int, 0644);
@@ -281,11 +277,6 @@ static uint loadparam(struct rtw_adapter
 	snprintf(registry_par->if2name, 16, "%s", if2name);
 
 	registry_par->notch_filter = (u8)rtw_notch_filter;
-
-#ifdef CONFIG_MULTI_VIR_IFACES
-	registry_par->ext_iface_num = (u8)rtw_ext_iface_num;
-#endif /* CONFIG_MULTI_VIR_IFACES */
-
 	return status;
 }
 
@@ -805,343 +796,6 @@ u8 rtw_free_drv_sw(struct rtw_adapter *p
 
 #ifdef CONFIG_CONCURRENT_MODE
 
-#include <usb_hal.h>
-
-#ifdef CONFIG_MULTI_VIR_IFACES
-int _netdev_vir_if_open(struct net_device *pnetdev)
-{
-	struct rtw_adapter *padapter = (struct rtw_adapter *)rtw_netdev_priv(pnetdev);
-	struct rtw_adapter *primary_padapter = GET_PRIMARY_ADAPTER(padapter);
-
-	DBG_8192D(FUNC_NDEV_FMT" enter\n", FUNC_NDEV_ARG(pnetdev));
-
-	if (!primary_padapter)
-		goto _netdev_virtual_iface_open_error;
-
-	if (primary_padapter->bup == false || primary_padapter->hw_init_completed == false)
-	{
-		_netdev_open(primary_padapter->pnetdev);
-	}
-
-	if (padapter->bup == false && primary_padapter->bup == true &&
-		primary_padapter->hw_init_completed == true)
-	{
-		int i;
-
-		padapter->bDriverStopped = false;
-		padapter->bSurpriseRemoved = false;
-		padapter->bCardDisableWOHSM = false;
-
-		memcpy(padapter->HalData, primary_padapter->HalData, padapter->hal_data_sz);
-
-		padapter->bFWReady = primary_padapter->bFWReady;
-
-		if (rtw_start_drv_threads(padapter) == _FAIL)
-		{
-			goto _netdev_virtual_iface_open_error;
-		}
-
-		padapter->dir_dev = NULL;
-
-#ifdef CONFIG_IOCTL_CFG80211
-		rtw_cfg80211_init_wiphy(padapter);
-#endif
-
-		padapter->bup = true;
-		padapter->hw_init_completed = true;
-
-		rtw_start_mbssid_cam(padapter);/* start mbssid_cam after bup = true & hw_init_completed = true */
-
-	}
-
-	padapter->net_closed = false;
-
-	_set_timer(&padapter->mlmepriv.dynamic_chk_timer, 2000);
-
-	if (!rtw_netif_queue_stopped(pnetdev))
-		rtw_netif_start_queue(pnetdev);
-	else
-		rtw_netif_wake_queue(pnetdev);
-
-	DBG_8192D(FUNC_NDEV_FMT" exit\n", FUNC_NDEV_ARG(pnetdev));
-	return 0;
-
-_netdev_virtual_iface_open_error:
-
-	padapter->bup = false;
-
-	netif_carrier_off(pnetdev);
-	rtw_netif_stop_queue(pnetdev);
-
-	return (-1);
-}
-
-int netdev_vir_if_open(struct net_device *pnetdev)
-{
-	int ret;
-	struct rtw_adapter *padapter = (struct rtw_adapter *)rtw_netdev_priv(pnetdev);
-
-	mutex_lock(&(adapter_to_dvobj(padapter)->hw_init_mutex));
-	ret = _netdev_vir_if_open(pnetdev);
-	mutex_unlock(&(adapter_to_dvobj(padapter)->hw_init_mutex));
-	return ret;
-}
-
-static int netdev_vir_if_close(struct net_device *pnetdev)
-{
-	struct rtw_adapter *padapter = (struct rtw_adapter *)rtw_netdev_priv(pnetdev);
-
-	padapter->net_closed = true;
-
-	if (pnetdev)
-	{
-		if (!rtw_netif_queue_stopped(pnetdev))
-			rtw_netif_stop_queue(pnetdev);
-	}
-
-#ifdef CONFIG_IOCTL_CFG80211
-	rtw_scan_abort(padapter);
-	wdev_to_priv(padapter->rtw_wdev)->bandroid_scan = false;
-#endif
-
-	return 0;
-}
-
-static const struct net_device_ops rtw_netdev_vir_if_ops = {
-	 .ndo_open = netdev_vir_if_open,
-        .ndo_stop = netdev_vir_if_close,
-        .ndo_start_xmit = rtw_xmit_entry,
-        .ndo_set_mac_address = rtw_net_set_mac_address,
-        .ndo_get_stats = rtw_net_get_stats,
-        .ndo_do_ioctl = rtw_ioctl,
-	.ndo_select_queue	= rtw_select_queue,
-};
-
-_adapter *rtw_drv_add_vir_if (struct rtw_adapter *primary_padapter, char *name,
-	void (*set_intf_ops)(struct _io_ops *pops))
-{
-
-	int res = _FAIL;
-	struct net_device *pnetdev;
-	struct rtw_adapter *padapter = NULL;
-	struct dvobj_priv *pdvobjpriv;
-	u8 mac[ETH_ALEN];
-
-	/****** init netdev ******/
-	pnetdev = rtw_init_netdev(NULL);
-	if (!pnetdev)
-		goto error_rtw_drv_add_iface;
-
-	DBG_8192D("register rtw_netdev_virtual_iface_ops to netdev_ops\n");
-	pnetdev->netdev_ops = &rtw_netdev_vir_if_ops;
-
-	/****** init adapter ******/
-	padapter = rtw_netdev_priv(pnetdev);
-	memcpy(padapter, primary_padapter, sizeof(struct rtw_adapter));
-
-	/*  */
-	padapter->bup = false;
-	padapter->net_closed = true;
-	padapter->hw_init_completed = false;
-
-	/* set adapter_type/iface type */
-	padapter->isprimary = false;
-	padapter->adapter_type = MAX_ADAPTER;
-	padapter->pbuddy_adapter = primary_padapter;
-	pr_debug("pbuddy_adapter: %p\n", primary_padapter);
-	/* extended virtual interfaces always are set to port0 */
-	padapter->iface_type = IFACE_PORT0;
-	/*  */
-	padapter->pnetdev = pnetdev;
-
-	/****** setup dvobj ******/
-	pdvobjpriv = adapter_to_dvobj(padapter);
-	padapter->iface_id = pdvobjpriv->iface_nums;
-	pdvobjpriv->padapters[pdvobjpriv->iface_nums++] = padapter;
-
-	SET_NETDEV_DEV(pnetdev, dvobj_to_dev(pdvobjpriv));
-#ifdef CONFIG_IOCTL_CFG80211
-	rtw_wdev_alloc(padapter, dvobj_to_dev(pdvobjpriv));
-#endif /* CONFIG_IOCTL_CFG80211 */
-
-	/* set interface_type/chip_type/HardwareType */
-	padapter->interface_type = primary_padapter->interface_type;
-	padapter->chip_type = primary_padapter->chip_type;
-	padapter->HardwareType = primary_padapter->HardwareType;
-
-	/* set hal data & hal ops */
-	rtl8192du_set_hal_ops(padapter);
-
-	padapter->HalFunc.inirp_init = NULL;
-	padapter->HalFunc.inirp_deinit = NULL;
-	padapter->intf_start = NULL;
-	padapter->intf_stop = NULL;
-
-	/* step init_io_priv */
-	if ((rtw_init_io_priv(padapter, set_intf_ops)) == _FAIL) {
-		RT_TRACE(_module_hci_intfs_c_, _drv_err_, ("\n Can't init io_reqs\n"));
-	}
-
-	/* step read_chip_version */
-	rtw_hal_read_chip_version(padapter);
-
-	/* step usb endpoint mapping */
-	rtw_hal_chip_configure(padapter);
-
-	/* init drv data */
-	if (rtw_init_drv_sw(padapter)!= _SUCCESS)
-		goto error_rtw_drv_add_iface;
-
-	/*  alloc dev name after got efuse data. */
-	if (name == NULL)
-		name = padapter->registrypriv.if2name;
-
-	rtw_init_netdev_name(pnetdev, name);
-	/* get mac address from primary_padapter */
-	memcpy(mac, primary_padapter->eeprompriv.mac_addr, ETH_ALEN);
-
-	if (((mac[0]== 0xff) &&(mac[1]== 0xff) && (mac[2]== 0xff) &&
-	     (mac[3]== 0xff) && (mac[4]== 0xff) &&(mac[5]== 0xff)) ||
-	    ((mac[0]== 0x0) && (mac[1]== 0x0) && (mac[2]== 0x0) &&
-	     (mac[3]== 0x0) && (mac[4]== 0x0) &&(mac[5]== 0x0)))
-	{
-		mac[0] = 0x00;
-		mac[1] = 0xe0;
-		mac[2] = 0x4c;
-		mac[3] = 0x87;
-		mac[4] = 0x11;
-		mac[5] = 0x22;
-	} else {
-		/* If the BIT1 is 0, the address is universally administered. */
-		/* If it is 1, the address is locally administered */
-		mac[0] |= BIT(1); /*  locally administered */
-		mac[0] |= (padapter->iface_id-1)<<4;
-	}
-
-	memcpy(padapter->eeprompriv.mac_addr, mac, ETH_ALEN);
-
-	memcpy(pnetdev->dev_addr, mac, ETH_ALEN);
-
-	padapter->dir_dev = NULL;
-
-	/* Tell the network stack we exist */
-	if (register_netdev(pnetdev) != 0)
-	/* if (register_netdevice(pnetdev) != 0) */
-	{
-		goto error_rtw_drv_add_iface;
-	}
-
-	DBG_8192D("MAC Address(%s) = %pM\n", pnetdev->name, mac);
-
-	res = _SUCCESS;
-
-	return padapter;
-
-error_rtw_drv_add_iface:
-
-	if (padapter)
-		rtw_free_drv_sw(padapter);
-
-	if (pnetdev)
-		rtw_free_netdev(pnetdev);
-
-	return NULL;
-}
-
-void rtw_drv_stop_vir_if (struct rtw_adapter *padapter)
-{
-	struct net_device *pnetdev = NULL;
-
-	if (padapter == NULL)
-		return;
-
-	pnetdev = padapter->pnetdev;
-
-	if (pnetdev)
-		unregister_netdev(pnetdev); /* will call netdev_close() */
-
-	rtw_cancel_all_timer(padapter);
-
-	if (padapter->bup == true) {
-		padapter->bDriverStopped = true;
-
-		if (padapter->xmitpriv.ack_tx)
-			rtw_ack_tx_done(&padapter->xmitpriv, RTW_SCTX_DONE_DRV_STOP);
-
-		if (padapter->intf_stop)
-			padapter->intf_stop(padapter);
-
-		rtw_stop_drv_threads(padapter);
-
-		padapter->bup = false;
-	}
-
-#ifdef CONFIG_IOCTL_CFG80211
-	rtw_wdev_unregister(padapter->rtw_wdev);
-#endif /* CONFIG_IOCTL_CFG80211 */
-}
-
-void rtw_drv_free_vir_if (struct rtw_adapter *padapter)
-{
-	struct net_device *pnetdev = NULL;
-
-	if (padapter == NULL)
-		return;
-
-	padapter->pbuddy_adapter = NULL;
-	pr_debug("pbuddy_adapter: %p\n", NULL);
-
-	pnetdev = padapter->pnetdev;
-
-#ifdef CONFIG_IOCTL_CFG80211
-	rtw_wdev_free(padapter->rtw_wdev);
-#endif /* CONFIG_IOCTL_CFG80211 */
-
-	rtw_free_drv_sw(padapter);
-
-	rtw_free_netdev(pnetdev);
-}
-
-void rtw_drv_stop_vir_ifaces(struct dvobj_priv *dvobj)
-{
-	int i;
-	/* struct dvobj_priv *dvobj = primary_padapter->dvobj; */
-
-	for (i = 2;i<dvobj->iface_nums;i++)
-	{
-		rtw_drv_stop_vir_if (dvobj->padapters[i]);
-	}
-}
-
-void rtw_drv_free_vir_ifaces(struct dvobj_priv *dvobj)
-{
-	int i;
-	/* struct dvobj_priv *dvobj = primary_padapter->dvobj; */
-
-	for (i = 2;i<dvobj->iface_nums;i++)
-	{
-		rtw_drv_free_vir_if (dvobj->padapters[i]);
-	}
-}
-
-void rtw_drv_del_vir_if (struct rtw_adapter *padapter)
-{
-	rtw_drv_stop_vir_if (padapter);
-	rtw_drv_free_vir_if (padapter);
-}
-
-void rtw_drv_del_vir_ifaces(struct rtw_adapter *primary_padapter)
-{
-	int i;
-	struct dvobj_priv *dvobj = primary_padapter->dvobj;
-
-	for (i = 2;i<dvobj->iface_nums;i++)
-	{
-		rtw_drv_del_vir_if (dvobj->padapters[i]);
-	}
-}
-#endif /* CONFIG_MULTI_VIR_IFACES */
-
 static int _netdev_if2_open(struct net_device *pnetdev)
 {
 	struct rtw_adapter *padapter = (struct rtw_adapter *)rtw_netdev_priv(pnetdev);
--- a/drivers/staging/rtl8192du/os_dep/usb_intf.c
+++ b/drivers/staging/rtl8192du/os_dep/usb_intf.c
@@ -825,12 +825,9 @@ static struct rtw_adapter  *rtw_sw_expor
 
 static int rtw_drv_init(struct usb_interface *pusb_intf, const struct usb_device_id *did)
 {
-	uint status = _FAIL;
 	struct rtw_adapter *if1 = NULL, *if2 = NULL;
 	struct dvobj_priv *dvobj = NULL;
-#ifdef CONFIG_MULTI_VIR_IFACES
-	int i;
-#endif /* CONFIG_MULTI_VIR_IFACES */
+	uint status = _FAIL;
 
 	/* step 0. */
 	process_spec_devid(did);
@@ -852,14 +849,6 @@ static int rtw_drv_init(struct usb_inter
 	if ((if2 = rtw_drv_if2_init(if1, NULL, usb_set_intf_ops)) == NULL) {
 		goto free_if1;
 	}
-#ifdef CONFIG_MULTI_VIR_IFACES
-	for (i=0; i<if1->registrypriv.ext_iface_num;i++) {
-		if (rtw_drv_add_vir_if (if1, "wlan%d", usb_set_intf_ops) == NULL) {
-			DBG_8192D("rtw_drv_add_iface failed! (%d)\n", i);
-			break;
-		}
-	}
-#endif /* CONFIG_MULTI_VIR_IFACES */
 #endif
 
 	status = _SUCCESS;
@@ -895,18 +884,12 @@ static void rtw_dev_remove(struct usb_in
 	LeaveAllPowerSaveMode(padapter);
 
 #ifdef CONFIG_CONCURRENT_MODE
-#ifdef CONFIG_MULTI_VIR_IFACES
-	rtw_drv_stop_vir_ifaces(dvobj);
-#endif /* CONFIG_MULTI_VIR_IFACES */
 	rtw_drv_if2_stop(dvobj->if2);
 #endif	/* CONFIG_CONCURRENT_MODE */
 
 	rtw_usb_if1_deinit(padapter);
 
 #ifdef CONFIG_CONCURRENT_MODE
-#ifdef CONFIG_MULTI_VIR_IFACES
-	rtw_drv_free_vir_ifaces(dvobj);
-#endif /* CONFIG_MULTI_VIR_IFACES */
 	rtw_drv_if2_free(dvobj->if2);
 #endif /* CONFIG_CONCURRENT_MODE */
 
