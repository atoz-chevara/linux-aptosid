From 6a0e3a9f6e234dd56992116a818b37fe4e00267e Mon Sep 17 00:00:00 2001
From: Chris Wilson <chris@chris-wilson.co.uk>
Date: Mon, 10 Jan 2011 14:21:05 +0000
Subject: [PATCH 039/190] drm/i915/evict: Ensure we completely cleanup on failure

... and not leave the objects in a inconsistent state.

Signed-off-by: Chris Wilson <chris@chris-wilson.co.uk>
Cc: stable@kernel.org
---
 drivers/gpu/drm/i915/i915_gem_evict.c |    9 ++++++++-
 1 files changed, 8 insertions(+), 1 deletions(-)

--- a/drivers/gpu/drm/i915/i915_gem_evict.c
+++ b/drivers/gpu/drm/i915/i915_gem_evict.c
@@ -114,9 +114,15 @@ i915_gem_evict_something(struct drm_devi
 	}
 
 	/* Nothing found, clean up and bail out! */
-	list_for_each_entry(obj_priv, &unwind_list, evict_list) {
+	while (!list_empty(&unwind_list)) {
+		obj_priv = list_first_entry(&unwind_list,
+				       struct drm_i915_gem_object,
+				       evict_list);
+
 		ret = drm_mm_scan_remove_block(obj_priv->gtt_space);
 		BUG_ON(ret);
+
+		list_del_init(&obj_priv->evict_list);
 		drm_gem_object_unreference(&obj_priv->base);
 	}
 
@@ -149,6 +155,7 @@ found:
 					    evict_list);
 		if (ret == 0)
 			ret = i915_gem_object_unbind(&obj_priv->base);
+
 		list_del(&obj_priv->evict_list);
 		drm_gem_object_unreference(&obj_priv->base);
 	}
